<!DOCTYPE html>

<html dir="rtl" lang="ur">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="Yasin Ullah, Pakistan" name="author" />
    <meta content="دارالایمان کربوغہ شریف - دینی مدرسہ زائرین کا انتظام" name="description" />
    <meta content="مدرسہ, زائرین, انتظام, دارالایمان, کربوغہ شریف, رپورٹس, تجزیات" name="keywords" />
    <title>دارالایمان کربوغہ شریف - زائرین کا انتظام</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #34a853;
            --accent-color: #fbbc05;
            --danger-color: #ea4335;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-color: #dee2e6;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Calibri', 'Noto Sans Arabic', Arial, sans-serif;
            direction: rtl;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            color: var(--text-color);
            font-size: 16px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card-bg);
            min-height: 100vh;
            box-shadow: var(--shadow);
        }

        .header {
            background: var(--primary-color);
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .dark-toggle {
            position: absolute;
            top: 25px;
            left: 25px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .nav-tabs {
            display: flex;
            background: var(--card-bg);
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
        }

        .nav-tab {
            background: none;
            border: none;
            padding: 18px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
        }

        .nav-tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 25px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 35px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 2.5rem;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color);
            font-size: 1rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1.1rem;
            transition: border-color 0.3s;
            direction: rtl;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-suggestion {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            font-size: 1rem;
        }

        .autocomplete-suggestion:hover {
            background: var(--bg-color);
        }

        .autocomplete-suggestion.selected {
            background: var(--primary-color);
            color: white;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 500;
            transition: all 0.3s;
            margin: 8px;
            font-family: inherit;
        }

        .btn:hover {
            background: #1e3d6f;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--secondary-color);
        }

        .btn-warning {
            background: var(--accent-color);
            color: #333;
        }

        .btn-danger {
            background: var(--danger-color);
        }

        .btn-info {
            background: #17a2b8;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .visitor-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            position: relative;
            transition: all 0.3s;
        }

        .visitor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .visitor-card.present {
            border-color: var(--secondary-color);
            background: linear-gradient(135deg, rgba(52, 168, 83, 0.1), rgba(52, 168, 83, 0.05));
        }

        .visitor-card.overstay {
            border-color: var(--danger-color);
            background: linear-gradient(135deg, rgba(234, 67, 53, 0.1), rgba(234, 67, 53, 0.05));
        }

        .visitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .visitor-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .visitor-status {
            background: var(--secondary-color);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .visitor-status.absent {
            background: var(--danger-color);
        }

        .visitor-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .visitor-detail {
            font-size: 1rem;
            line-height: 1.5;
        }

        .visitor-detail strong {
            color: var(--primary-color);
            font-weight: bold;
        }

        .visitor-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .filters {
            background: var(--bg-color);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .search-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .search-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1.1rem;
            direction: rtl;
        }

        .advanced-filters {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
        }

        .filter-toggle {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 1rem;
            text-decoration: underline;
            margin-top: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            margin: 30px auto;
            padding: 25px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h3 {
            color: var(--primary-color);
            font-size: 1.4rem;
            font-weight: bold;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--danger-color);
        }

        .reports-section {
            background: var(--bg-color);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .reports-section h3 {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .export-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }

        .report-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
            font-size: 1rem;
        }

        .data-table th {
            background: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        .data-table tr:hover {
            background: var(--bg-color);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            background: white;
            cursor: pointer;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .page-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .group-tag {
            background: var(--accent-color);
            color: #333;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 5px;
        }

        .bulk-actions {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: none;
        }

        .bulk-actions.active {
            display: block;
        }

        .visitor-checkbox {
            margin-left: 10px;
            transform: scale(1.2);
        }

        body.dark {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --border-color: #404040;
            --primary-color: #5b8ad2;
            --secondary-color: #4CAF50;
            --accent-color: #fdd835;
            --danger-color: #ef5350;
        }

        body.dark .nav-tab {
            color: #ccc;
        }

        body.dark .nav-tab.active {
            color: var(--primary-color);
        }

        body.dark .stat-card {
            background: linear-gradient(135deg, var(--primary-color), #204a87);
        }

        body.dark .autocomplete-suggestions {
            background: var(--card-bg);
        }

        body.dark .autocomplete-suggestion {
            color: var(--text-color);
        }

        body.dark .autocomplete-suggestion:hover {
            background: var(--bg-color);
        }

        body.dark .data-table th {
            background: var(--primary-color);
        }

        body.dark .data-table tr:hover {
            background: #3a3a3a;
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .nav-tabs {
                justify-content: space-around;
            }

            .nav-tab {
                padding: 15px 12px;
                font-size: 0.9rem;
            }

            .tab-content {
                padding: 20px 15px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .visitor-actions {
                justify-content: center;
            }

            .modal-content {
                margin: 10px;
                max-width: none;
            }
        }

        *,
        button,
        input,
        select,
        textarea {
            font-family: inherit;
            font-size: inherit;
            color: inherit;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .chart-card h3 {
            text-align: center;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.2rem;
            font-weight: bold;
        }

        .reports-grouped-section .reports-section {
            margin-bottom: 15px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="manifest.json" rel="manifest" />
    <link href="favicon.ico" rel="icon" type="image/x-icon" />
</head>

<body>
    <div class="container">
        <header class="header">
            <button class="dark-toggle" onclick="toggleDarkMode()">🌙 ڈارک موڈ</button>
            <h1>دارالایمان کربوغہ شریف</h1>
            <p>زائرین کا انتظام</p>
        </header>
        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">ڈیش بورڈ</button>
            <button class="nav-tab" data-tab="visitors">زائرین کی فہرست</button>
            <button class="nav-tab" data-tab="add-visitor">نیا زائر</button>
            <button class="nav-tab" data-tab="reports">رپورٹس</button>
            <button class="nav-tab" data-tab="analytics">تجزیات</button>
            <button class="nav-tab" data-tab="settings">سیٹنگز</button>
        </nav>
        <div class="tab-content active" id="dashboard">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="total-visitors">0</h3>
                    <p>کل زائرین</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-attendees">0</h3>
                    <p>کل حاضری</p>
                </div>
                <div class="stat-card">
                    <h3 id="today-visitors">0</h3>
                    <p>آج کے زائرین</p>
                </div>
                <div class="stat-card">
                    <h3 id="present-visitors">0</h3>
                    <p>موجودہ زائرین</p>
                </div>
                <div class="stat-card">
                    <h3 id="present-attendees">0</h3>
                    <p>موجودہ حاضری</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-groups">0</h3>
                    <p>کل گروپس</p>
                </div>
                <div class="stat-card">
                    <h3 id="average-stay">0</h3>
                    <p>اوسط قیام (دن)</p>
                </div>
                <div class="stat-card">
                    <h3 id="monthly-growth">0%</h3>
                    <p>ماہانہ اضافہ</p>
                </div>
            </div>
            <div class="reports-section">
                <h3>حالیہ زائرین</h3>
                <div id="recent-visitors"></div>
                <button class="btn" onclick="showTab('visitors')">تمام زائرین دیکھیں</button>
            </div>
        </div>
        <div class="tab-content" id="visitors">
            <div class="search-box">
                <input class="search-input" id="global-search" oninput="globalSearch()"
                    placeholder="نام، فون، پتہ، یا مقصد سے تلاش کریں..." type="text" />
                <button class="filter-toggle" onclick="toggleAdvancedFilters()">تفصیلی فلٹرز</button>
            </div>
            <div class="filters advanced-filters" id="advanced-filters">
                <div class="filter-grid">
                    <div class="form-group">
                        <label>تاریخ سے</label>
                        <input id="filter-date-from" onchange="filterVisitors()" type="date" />
                    </div>
                    <div class="form-group">
                        <label>تاریخ تک</label>
                        <input id="filter-date-to" onchange="filterVisitors()" type="date" />
                    </div>
                    <div class="form-group">
                        <label>قسم</label>
                        <select id="filter-type" onchange="filterVisitors()">
                            <option value="">تمام</option>
                            <option value="فرد">فرد</option>
                            <option value="گروپ">گروپ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>موجودگی</label>
                        <select id="filter-status" onchange="filterVisitors()">
                            <option value="">تمام</option>
                            <option value="present">موجود</option>
                            <option value="absent">غیر موجود</option>
                            <option value="overstay">حد سے زیادہ قیام</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>شہر</label>
                        <select id="filter-city" onchange="filterVisitors()">
                            <option value="">تمام شہر</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>مقصد</label>
                        <select id="filter-purpose" onchange="filterVisitors()">
                            <option value="">تمام مقاصد</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-warning" onclick="clearAllFilters()">فلٹرز صاف کریں</button>
                    <button class="btn btn-info" onclick="exportFiltered()">فلٹرڈ ڈیٹا ایکسپورٹ</button>
                </div>
            </div>
            <div class="bulk-actions" id="bulk-actions">
                <button class="btn btn-danger" onclick="bulkDelete()">منتخب کردہ حذف کریں</button>
                <button class="btn btn-info" onclick="bulkExport()">منتخب کردہ ایکسپورٹ</button>
                <button class="btn btn-warning" onclick="clearSelection()">انتخاب صاف کریں</button>
            </div>
            <div id="visitors-list"></div>
            <div class="pagination" id="pagination"></div>
        </div>
        <div class="tab-content" id="add-visitor">
            <h3>نیا زائر شامل کریں</h3>
            <form id="visitor-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>نام *</label>
                        <input id="visitor-name" required="" type="text" />
                    </div>
                    <div class="form-group">
                        <label>فون نمبر</label>
                        <input id="visitor-phone" type="tel" />
                    </div>
                    <div class="form-group autocomplete-container">
                        <label>پتہ</label>
                        <textarea id="visitor-address" oninput="handleAddressAutocomplete(this.value)"
                            rows="3"></textarea>
                        <div class="autocomplete-suggestions" id="address-suggestions"></div>
                    </div>
                    <div class="form-group">
                        <label>تاریخ آمد *</label>
                        <input id="arrival-date" onchange="updateDepartureDate()" required="" type="date" />
                    </div>
                    <div class="form-group">
                        <label>آمد کا وقت</label>
                        <input id="arrival-time" type="time" />
                    </div>
                    <div class="form-group">
                        <label>تاریخ روانگی</label>
                        <input id="departure-date" onchange="updateStayDuration()" type="date" />
                    </div>
                    <div class="form-group">
                        <label>قیام کے دن</label>
                        <input id="stay-duration" min="0" oninput="updateDepartureDate()" placeholder="مثلاً 5"
                            type="number" />
                    </div>
                    <div class="form-group">
                        <label>قسم *</label>
                        <select id="visitor-type" onchange="toggleGroupCount()" required="">
                            <option value="">منتخب کریں</option>
                            <option value="فرد">فرد</option>
                            <option value="گروپ">گروپ</option>
                        </select>
                    </div>
                    <div class="form-group" id="group-count-section" style="display: none;">
                        <label>افراد کی تعداد *</label>
                        <input id="group-count" max="1000" min="1" type="number" />
                    </div>
                    <div class="form-group">
                        <label>مقصد</label>
                        <select id="visit-purpose-select" onchange="handlePurposeSelect()">
                            <option value="">منتخب کریں یا نیا لکھیں</option>
                            <option value="مذہبی تعلیم">مذہبی تعلیم</option>
                            <option value="زیارت">زیارت</option>
                            <option value="دعا اور تلاوت">دعا اور تلاوت</option>
                            <option value="مذہبی اجتماع">مذہبی اجتماع</option>
                            <option value="عرس شریف">عرس شریف</option>
                            <option value="custom">نیا مقصد</option>
                        </select>
                        <textarea id="visit-purpose" placeholder="اپنا مقصد لکھیں" rows="2"
                            style="margin-top: 10px; display: none;"></textarea>
                    </div>
                    <div class="form-group">
                        <label>گروپ ٹیگ</label>
                        <input id="group-tag" placeholder="اختیاری - گروپ کا نام یا ٹیگ" type="text" />
                    </div>
                    <div class="form-group">
                        <label>ذمہ دار شخص</label>
                        <input id="responsible-person" placeholder="گروپ کے ذمہ دار کا نام" type="text" />
                    </div>
                    <div class="form-group">
                        <label>خصوصی نوٹس</label>
                        <textarea id="special-notes" placeholder="کوئی خصوصی ہدایات یا نوٹس" rows="2"></textarea>
                    </div>
                </div>
                <button class="btn" type="submit">زائر شامل کریں</button>
                <button class="btn btn-warning" onclick="resetForm()" type="button">صاف کریں</button>
                <button class="btn btn-info" onclick="quickAddGroup()" type="button">فوری گروپ اندراج</button>
            </form>
        </div>
        <div class="tab-content" id="reports">
            <div class="reports-section">
                <h3>رپورٹ فلٹرز</h3>
                <div class="report-filters">
                    <div class="form-group">
                        <label>تاریخ سے</label>
                        <input id="report-date-from" onchange="generateReports()" type="date" />
                    </div>
                    <div class="form-group">
                        <label>تاریخ تک</label>
                        <input id="report-date-to" onchange="generateReports()" type="date" />
                    </div>
                    <div class="form-group">
                        <label>رپورٹ کی قسم</label>
                        <select id="report-type" onchange="generateReports()">
                            <option value="all">تمام ڈیٹا</option>
                            <option value="daily-arrivals">یومیہ آمد</option>
                            <option value="daily-departures">یومیہ روانگی</option>
                            <option value="currently-present">موجودہ حاضری</option>
                            <option value="upcoming-activity">آئندہ 7 دن</option>
                            <option value="special-needs">خصوصی ضروریات</option>
                            <option value="overstay">حد سے زیادہ قیام</option>
                            <option value="period-summary">مدت کا خلاصہ</option>
                            <option value="purpose-breakdown">مقصد کے لحاظ سے تقسیم</option>
                            <option value="geographic-breakdown">جغرافیائی تقسیم</option>
                            <option value="custom">حسب ضرورت</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>گروپ بذریعہ</label>
                        <select id="group-by" onchange="generateReports()">
                            <option value="none">کوئی گروپنگ نہیں</option>
                            <option value="city">شہر کے حساب سے</option>
                            <option value="purpose">مقصد کے حساب سے</option>
                            <option value="type">قسم کے حساب سے</option>
                            <option value="month">ماہ کے حساب سے</option>
                        </select>
                    </div>
                </div>
                <div class="export-buttons">
                    <button class="btn btn-warning" onclick="clearReportFilters()">فلٹرز صاف کریں</button>
                    <button class="btn btn-success" onclick="exportToExcel('current_report')">رپورٹ Excel</button>
                    <button class="btn btn-info" onclick="generatePDFReport()">PDF رپورٹ</button>
                    <button class="btn btn-warning" onclick="printReport()">پرنٹ کریں</button>
                </div>
            </div>
            <div id="reports-container"></div>
            <div class="pagination" id="report-pagination"></div>
        </div>
        <div class="tab-content" id="analytics">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="analytics-peak-day">--</h3>
                    <p>سب سے زیادہ آنے والا دن</p>
                </div>
                <div class="stat-card">
                    <h3 id="analytics-avg-group-size">--</h3>
                    <p>اوسط گروپ سائز</p>
                </div>
                <div class="stat-card">
                    <h3 id="analytics-return-visitors">--</h3>
                    <p>دوبارہ آنے والے</p>
                </div>
                <div class="stat-card">
                    <h3 id="analytics-popular-purpose">--</h3>
                    <p>مشہور ترین مقصد</p>
                </div>
            </div>
            <div class="filters"
                style="padding: 20px; background-color: var(--bg-color); border-radius: 12px; margin-bottom: 25px;">
                <div class="filter-grid">
                    <div class="form-group">
                        <label>تاریخ سے</label>
                        <input id="analytics-date-from" onchange="loadAnalytics()" type="date" />
                    </div>
                    <div class="form-group">
                        <label>تاریخ تک</label>
                        <input id="analytics-date-to" onchange="loadAnalytics()" type="date" />
                    </div>
                    <div class="form-group">
                        <label>زائر کی قسم</label>
                        <select id="analytics-type-filter" onchange="loadAnalytics()">
                            <option value="all">تمام</option>
                            <option value="فرد">فرد</option>
                            <option value="گروپ">گروپ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>پہلی مدت سے (موازنہ)</label>
                        <input id="compare-from1" onchange="loadAnalytics()" type="date" />
                    </div>
                    <div class="form-group">
                        <label>پہلی مدت تک (موازنہ)</label>
                        <input id="compare-to1" onchange="loadAnalytics()" type="date" />
                    </div>
                    <div class="form-group">
                        <label>دوسری مدت سے (موازنہ)</label>
                        <input id="compare-from2" onchange="loadAnalytics()" type="date" />
                    </div>
                    <div class="form-group">
                        <label>دوسری مدت تک (موازنہ)</label>
                        <input id="compare-to2" onchange="loadAnalytics()" type="date" />
                    </div>
                    <div class="form-group">
                        <label>گروپ ٹیگز (موازنہ)</label>
                        <select id="group-tag-compare" multiple="" onchange="loadAnalytics()">
                        </select>
                    </div>
                    <div class="form-group" style="align-items: flex-end;">
                        <button class="btn btn-warning" onclick="resetAnalyticsFilters()">فلٹرز صاف کریں</button>
                    </div>
                </div>
            </div>
            <div class="reports-section">
                <h3>تجزیات کے چارٹس</h3>
                <div id="analytics-charts">
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h3>آمدورفت کا رجحان (وقت کے ساتھ)</h3>
                            <canvas id="visitorsOverTimeChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>صوبے کے لحاظ سے تقسیم</h3>
                            <canvas id="provinceDistributionChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>مقصد کے لحاظ سے تقسیم</h3>
                            <canvas id="purposeDistributionChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>زائرین کی قسم (فرد/گروپ)</h3>
                            <canvas id="visitorTypeChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>قیام کی مدت کی تقسیم</h3>
                            <canvas id="stayDurationChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>ماہانہ آمد کا رجحان</h3>
                            <canvas id="monthlyArrivalsChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>مختلف مقاصد کا رجحان</h3>
                            <canvas id="purposeTrendChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>یومیہ آمد کا رجحان</h3>
                            <canvas id="dailyArrivalsChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>گھنٹہ وار آمد کا رجحان</h3>
                            <canvas id="hourlyArrivalsChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="reports-section" id="analytics-tables">
                    <h3>تفصیلی تجزیات (جدول)</h3>
                </div>
            </div>
            <div class="reports-section" id="comparative-analysis-section">
                <h3>موازنہ کا تجزیہ</h3>
                <div id="comparative-analysis-content"></div>
            </div>
            <div class="pagination" id="analytics-pagination"></div>
        </div>
        <div class="tab-content" id="settings">
            <div class="reports-section">
                <h3>بیک اپ اور بحالی</h3>
                <div class="export-buttons">
                    <button class="btn btn-success" onclick="backupData()">مکمل ڈیٹا بیک اپ</button>
                    <button class="btn btn-warning" onclick="document.getElementById('restore-file').click()">ڈیٹا بحال
                        کریں</button>
                    <input accept=".json" id="restore-file" onchange="restoreData(event)" style="display: none;"
                        type="file" />
                </div>
            </div>
            <div class="reports-section">
                <h3>ڈیٹا صفائی</h3>
                <div class="export-buttons">
                    <button class="btn btn-warning" onclick="cleanOldData()">پرانا ڈیٹا صاف کریں</button>
                    <button class="btn btn-danger" onclick="clearAllData()">تمام ڈیٹا حذف کریں</button>
                </div>
            </div>
            <div class="reports-section">
                <h3>ڈیٹا کوالٹی</h3>
                <div class="export-buttons">
                    <button class="btn btn-info" onclick="showIncompleteRecords()">نامکمل ریکارڈز</button>
                    <button class="btn btn-info" onclick="showPotentialDuplicates()">ممکنہ نقلیں</button>
                </div>
                <div id="data-quality-results" style="margin-top: 20px;"></div>
            </div>
            <div class="reports-section">
                <h3>سیٹنگز</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>خودکار بیک اپ</label>
                        <select id="auto-backup">
                            <option value="never">کبھی نہیں</option>
                            <option value="daily">روزانہ</option>
                            <option value="weekly">ہفتہ وار</option>
                            <option value="monthly">ماہانہ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>صفحہ میں ریکارڈز (فہرست)</label>
                        <select id="records-per-page" onchange="updateRecordsPerPage()">
                            <option value="10">10</option>
                            <option selected="" value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>رپورٹس میں ریکارڈز فی صفحہ</label>
                        <select id="reports-records-per-page" onchange="updateReportsRecordsPerPage()">
                            <option value="10">10</option>
                            <option selected="" value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>تجزیات میں ریکارڈز فی صفحہ</label>
                        <select id="analytics-records-per-page" onchange="updateAnalyticsRecordsPerPage()">
                            <option value="10">10</option>
                            <option selected="" value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="edit-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>زائر میں تبدیلی</h3>
                <button class="close-modal" onclick="closeEditModal()">×</button>
            </div>
            <form id="edit-visitor-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>نام *</label>
                        <input id="edit-visitor-name" required="" type="text" />
                    </div>
                    <div class="form-group">
                        <label>فون نمبر</label>
                        <input id="edit-visitor-phone" type="tel" />
                    </div>
                    <div class="form-group autocomplete-container">
                        <label>پتہ</label>
                        <textarea id="edit-visitor-address" oninput="handleAddressAutocomplete(this.value, 'edit')"
                            rows="3"></textarea>
                        <div class="autocomplete-suggestions" id="edit-address-suggestions"></div>
                    </div>
                    <div class="form-group">
                        <label>تاریخ آمد *</label>
                        <input id="edit-arrival-date" onchange="updateDepartureDate('edit')" required="" type="date" />
                    </div>
                    <div class="form-group">
                        <label>آمد کا وقت</label>
                        <input id="edit-arrival-time" type="time" />
                    </div>
                    <div class="form-group">
                        <label>تاریخ روانگی</label>
                        <input id="edit-departure-date" onchange="updateStayDuration('edit')" type="date" />
                    </div>
                    <div class="form-group">
                        <label>قیام کے دن</label>
                        <input id="edit-stay-duration" min="0" oninput="updateDepartureDate('edit')"
                            placeholder="مثلاً 5" type="number" />
                    </div>
                    <div class="form-group">
                        <label>قسم *</label>
                        <select id="edit-visitor-type" onchange="toggleEditGroupCount()" required="">
                            <option value="فرد">فرد</option>
                            <option value="گروپ">گروپ</option>
                        </select>
                    </div>
                    <div class="form-group" id="edit-group-count-section">
                        <label>افراد کی تعداد</label>
                        <input id="edit-group-count" min="1" type="number" />
                    </div>
                    <div class="form-group">
                        <label>مقصد</label>
                        <textarea id="edit-visit-purpose" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>گروپ ٹیگ</label>
                        <input id="edit-group-tag" type="text" />
                    </div>
                    <div class="form-group">
                        <label>ذمہ دار شخص</label>
                        <input id="edit-responsible-person" type="text" />
                    </div>
                    <div class="form-group">
                        <label>خصوصی نوٹس</label>
                        <textarea id="edit-special-notes" rows="2"></textarea>
                    </div>
                </div>
                <button class="btn" type="submit">تبدیلی محفوظ کریں</button>
                <button class="btn btn-warning" onclick="closeEditModal()" type="button">منسوخ</button>
            </form>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let db;
        let analyticsCharts = {};
        let currentEditId = null;
        let selectedVisitors = new Set();
        let visitorsCurrentPage = 1;
        let reportsCurrentPage = 1;
        let analyticsCurrentPage = 1;
        let recordsPerPageVisitors = 25;
        let recordsPerPageReports = 25;
        let recordsPerPageAnalytics = 25;
        let allVisitors = [];
        let filteredVisitors = [];
        let reportedVisitors = [];
        let analyticData = [];
        const sampleVisitors = [
            {
                id: Date.now() + 1,
                name: "محمد احمد خان",
                phone: "0300-1234567",
                address: "گلبرگ، لاہور، پنجاب",
                arrivalDate: "2025-08-01",
                arrivalTime: "10:30",
                departureDate: "2025-08-05",
                type: "گروپ",
                groupCount: 15,
                purpose: "مذہبی تعلیم",
                groupTag: "لاہور جماعت",
                responsiblePerson: "حافظ علی احمد",
                specialNotes: "خصوصی کھانے کی ضرورت",
                addedDate: new Date("2025-07-29T10:00:00Z").toISOString()
            },
            {
                id: Date.now() + 2,
                name: "علی حسن شاہ",
                phone: "0321-9876543",
                address: "کلفٹن، کراچی، سندھ",
                arrivalDate: "2025-08-02",
                arrivalTime: "14:00",
                departureDate: "2025-08-06",
                type: "گروپ",
                groupCount: 25,
                purpose: "زیارت",
                groupTag: "کراچی سوسائٹی",
                responsiblePerson: "ڈاکٹر محمد علی",
                specialNotes: "",
                addedDate: new Date("2025-08-01T11:30:00Z").toISOString()
            },
            {
                id: Date.now() + 3,
                name: "فاطمہ خان بیگم",
                phone: "0333-5555555",
                address: "ایف سکس، اسلام آباد",
                arrivalDate: "2025-08-01",
                arrivalTime: "09:00",
                departureDate: "2025-08-03",
                type: "فرد",
                groupCount: 1,
                purpose: "دعا اور تلاوت",
                groupTag: "",
                responsiblePerson: "",
                specialNotes: "دوا کی ضرورت",
                addedDate: new Date("2025-07-31T09:00:00Z").toISOString()
            },
            {
                id: Date.now() + 4,
                name: "عبدالرحمن محمود",
                phone: "0345-7777777",
                address: "ساماں آباد، فیصل آباد، پنجاب",
                arrivalDate: "2025-07-30",
                arrivalTime: "11:00",
                departureDate: "2025-08-04",
                type: "گروپ",
                groupCount: 12,
                purpose: "مذہبی اجتماع",
                groupTag: "فیصل آباد ٹولی",
                responsiblePerson: "مولانا عبدالجبار",
                specialNotes: "",
                addedDate: new Date("2025-07-28T14:00:00Z").toISOString()
            }
        ];
        function populatePurposeSelects() {
            if (!db) return;
            const transaction = db.transaction(['purposes'], 'readonly');
            const objectStore = transaction.objectStore('purposes');
            const request = objectStore.getAll();
            request.onsuccess = function () {
                const dbPurposes = request.result.map(p => p.purpose);
                const purposeSelect = document.getElementById('visit-purpose-select');
                const filterSelect = document.getElementById('filter-purpose');
                const defaultPurposes = ["مذہبی تعلیم", "زیارت", "دعا اور تلاوت", "مذہبی اجتماع", "عرس شریف"];
                const allPurposes = [...new Set([...defaultPurposes, ...dbPurposes])].sort();
                const customOption = purposeSelect.querySelector('option[value="custom"]');
                const firstOption = purposeSelect.options[0];
                purposeSelect.innerHTML = '';
                purposeSelect.appendChild(firstOption);
                allPurposes.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p;
                    option.textContent = p;
                    purposeSelect.appendChild(option);
                });
                purposeSelect.appendChild(customOption);
                const firstFilterOption = filterSelect.options[0];
                filterSelect.innerHTML = '';
                filterSelect.appendChild(firstFilterOption);
                allPurposes.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p;
                    option.textContent = p;
                    filterSelect.appendChild(option);
                });
            };
        }
        function initDB() {
            const request = indexedDB.open('VisitorsDB', 3);
            request.onerror = function () {
                console.error('Database failed to open');
            };
            request.onsuccess = function () {
                db = request.result;
                //loadSampleData();
                loadDashboard();
                loadVisitorsList();
                populateFilterOptions();
                scheduleAutoBackup();
                populateGroupTagCompareSelect();
            };
            request.onupgradeneeded = function (e) {
                db = e.target.result;
                if (!db.objectStoreNames.contains('visitors')) {
                    const objectStore = db.createObjectStore('visitors', { keyPath: 'id' });
                    objectStore.createIndex('name', 'name', { unique: false });
                    objectStore.createIndex('arrivalDate', 'arrivalDate', { unique: false });
                    objectStore.createIndex('type', 'type', { unique: false });
                    objectStore.createIndex('address', 'address', { unique: false });
                    objectStore.createIndex('purpose', 'purpose', { unique: false });
                    objectStore.createIndex('departureDate', 'departureDate', { unique: false });
                }
                if (!db.objectStoreNames.contains('purposes')) {
                    const purposeStore = db.createObjectStore('purposes', { keyPath: 'id', autoIncrement: true });
                    purposeStore.createIndex('purpose', 'purpose', { unique: true });
                }
                if (!db.objectStoreNames.contains('addresses')) {
                    const addressStore = db.createObjectStore('addresses', { keyPath: 'id', autoIncrement: true });
                    addressStore.createIndex('address', 'address', { unique: true });
                }
                if (e.oldVersion < 3) {
                    const visitorStore = e.target.transaction.objectStore('visitors');
                    if (!visitorStore.indexNames.contains('groupTag')) {
                        visitorStore.createIndex('groupTag', 'groupTag', { unique: false });
                    }
                    if (!visitorStore.indexNames.contains('arrivalTime')) {
                        visitorStore.createIndex('arrivalTime', 'arrivalTime', { unique: false });
                    }
                }
            };
        }
        function loadSampleData() {
            const transaction = db.transaction(['visitors', 'addresses', 'purposes'], 'readwrite');
            const visitorStore = transaction.objectStore('visitors');
            const addressStore = transaction.objectStore('addresses');
            const purposeStore = transaction.objectStore('purposes');
            const countRequest = visitorStore.count();
            countRequest.onsuccess = function () {
                if (countRequest.result === 0) {
                    sampleVisitors.forEach(visitor => {
                        visitorStore.add(visitor);
                        addressStore.index('address').get(visitor.address.trim()).onsuccess = function (event) {
                            if (!event.target.result) {
                                addressStore.add({ address: visitor.address.trim(), count: 1 });
                            }
                        };
                        if (visitor.purpose) {
                            purposeStore.index('purpose').get(visitor.purpose.trim()).onsuccess = function (event) {
                                if (!event.target.result) {
                                    purposeStore.add({ purpose: visitor.purpose.trim() });
                                }
                            };
                        }
                    });
                }
            };
        }
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.nav-tab[data-tab="${tabName}"]`).classList.add('active');
            if (tabName === 'visitors') {
                loadVisitorsList();
            } else if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'reports') {
                loadReports();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            }
        }
        function toggleGroupCount(context = 'add') {
            const prefix = context === 'edit' ? 'edit-' : '';
            const type = document.getElementById(`${prefix}visitor-type`).value;
            const section = document.getElementById(`${prefix}group-count-section`);
            section.style.display = type === 'گروپ' ? 'block' : 'none';
            if (type === 'گروپ') {
                document.getElementById(`${prefix}group-count`).required = true;
            } else {
                document.getElementById(`${prefix}group-count`).required = false;
            }
        }
        function handlePurposeSelect() {
            const select = document.getElementById('visit-purpose-select');
            const textarea = document.getElementById('visit-purpose');
            if (select.value === 'custom') {
                textarea.style.display = 'block';
                textarea.focus();
                textarea.value = '';
            } else {
                textarea.style.display = 'none';
                textarea.value = select.value;
            }
        }
        function saveAddressToAutocomplete(address) {
            if (!address || address.trim() === '') return;
            const transaction = db.transaction(['addresses'], 'readwrite');
            const objectStore = transaction.objectStore('addresses');
            const checkRequest = objectStore.index('address').get(address.trim());
            checkRequest.onsuccess = function () {
                if (!checkRequest.result) {
                    objectStore.add({ address: address.trim(), count: 1 });
                } else {
                    checkRequest.result.count++;
                    objectStore.put(checkRequest.result);
                }
            };
            checkRequest.onerror = function (event) {
                console.error('Error checking address for autocomplete:', event.target.error);
            };
        }
        function handleAddressAutocomplete(value, context = 'add') {
            const suggestionsId = context === 'edit' ? 'edit-address-suggestions' : 'address-suggestions';
            const suggestionsDiv = document.getElementById(suggestionsId);
            if (value.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            const transaction = db.transaction(['addresses'], 'readonly');
            const objectStore = transaction.objectStore('addresses');
            const request = objectStore.getAll();
            request.onsuccess = function () {
                const addresses = request.result;
                const filtered = addresses
                    .filter(addr => addr.address.includes(value))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5);
                if (filtered.length > 0) {
                    suggestionsDiv.innerHTML = filtered
                        .map(addr => `<div class="autocomplete-suggestion" onclick="selectAddress('${addr.address}', '${context}')">${addr.address}</div>`)
                        .join('');
                    suggestionsDiv.style.display = 'block';
                } else {
                    suggestionsDiv.style.display = 'none';
                }
            };
            request.onerror = function (event) {
                console.error('Error fetching addresses for autocomplete:', event.target.error);
            };
        }
        function selectAddress(address, context) {
            const inputId = context === 'edit' ? 'edit-visitor-address' : 'visitor-address';
            const suggestionsId = context === 'edit' ? 'edit-address-suggestions' : 'address-suggestions';
            document.getElementById(inputId).value = address;
            document.getElementById(suggestionsId).style.display = 'none';
        }
        function resetForm() {
            document.getElementById('visitor-form').reset();
            document.getElementById('group-count-section').style.display = 'none';
            document.getElementById('visit-purpose').style.display = 'none';
            document.getElementById('visit-purpose-select').value = '';
            document.getElementById('address-suggestions').style.display = 'none';
            document.getElementById('arrival-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('departure-date').value = '';
            document.getElementById('stay-duration').value = '';
            document.getElementById('arrival-time').value = new Date().toTimeString().split(' ')[0].substring(0, 5);
        }
        function quickAddGroup() {
            document.getElementById('visitor-type').value = 'گروپ';
            toggleGroupCount();
            document.getElementById('group-count').focus();
        }
        document.getElementById('visitor-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const purposeSelect = document.getElementById('visit-purpose-select').value;
            const purposeText = document.getElementById('visit-purpose').value;
            const finalPurpose = purposeSelect === 'custom' ? purposeText : purposeSelect;
            const visitor = {
                id: Date.now(),
                name: document.getElementById('visitor-name').value,
                phone: document.getElementById('visitor-phone').value,
                address: document.getElementById('visitor-address').value,
                arrivalDate: document.getElementById('arrival-date').value,
                arrivalTime: document.getElementById('arrival-time').value,
                departureDate: document.getElementById('departure-date').value,
                type: document.getElementById('visitor-type').value,
                groupCount: document.getElementById('visitor-type').value === 'گروپ' ?
                    parseInt(document.getElementById('group-count').value) || 1 : 1,
                purpose: finalPurpose,
                groupTag: document.getElementById('group-tag').value,
                responsiblePerson: document.getElementById('responsible-person').value,
                specialNotes: document.getElementById('special-notes').value,
                addedDate: new Date().toISOString()
            };
            const transaction = db.transaction(['visitors', 'purposes'], 'readwrite');
            const objectStore = transaction.objectStore('visitors');
            const purposeStore = transaction.objectStore('purposes');
            const request = objectStore.add(visitor);
            request.onsuccess = function () {
                if (finalPurpose.trim() !== '') {
                    const checkReq = purposeStore.index('purpose').get(finalPurpose.trim());
                    checkReq.onsuccess = () => {
                        if (!checkReq.result) {
                            purposeStore.add({ purpose: finalPurpose.trim() });
                        }
                    };
                }
                saveAddressToAutocomplete(visitor.address);
                resetForm();
                loadDashboard();
                loadVisitorsList();
                populateFilterOptions();
                populatePurposeSelects();
                populateGroupTagCompareSelect();
                alert('زائر کامیابی سے شامل ہو گیا!');
            };
            request.onerror = function (event) {
                console.error('Error adding visitor:', event.target.error);
                alert('زائر کو شامل کرنے میں خرابی پیش آئی: ' + event.target.error.message);
            };
        });
        document.getElementById('edit-visitor-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const visitor = {
                id: currentEditId,
                name: document.getElementById('edit-visitor-name').value,
                phone: document.getElementById('edit-visitor-phone').value,
                address: document.getElementById('edit-visitor-address').value,
                arrivalDate: document.getElementById('edit-arrival-date').value,
                arrivalTime: document.getElementById('edit-arrival-time').value,
                departureDate: document.getElementById('edit-departure-date').value,
                type: document.getElementById('edit-visitor-type').value,
                groupCount: document.getElementById('edit-visitor-type').value === 'گروپ' ?
                    parseInt(document.getElementById('edit-group-count').value) || 1 : 1,
                purpose: document.getElementById('edit-visit-purpose').value,
                groupTag: document.getElementById('edit-group-tag').value,
                responsiblePerson: document.getElementById('edit-responsible-person').value,
                specialNotes: document.getElementById('edit-special-notes').value,
                addedDate: new Date().toISOString()
            };
            const transaction = db.transaction(['visitors', 'purposes'], 'readwrite');
            const objectStore = transaction.objectStore('visitors');
            const purposeStore = transaction.objectStore('purposes');
            const request = objectStore.put(visitor);
            request.onsuccess = function () {
                if (visitor.purpose.trim() !== '') {
                    const checkReq = purposeStore.index('purpose').get(visitor.purpose.trim());
                    checkReq.onsuccess = () => {
                        if (!checkReq.result) {
                            purposeStore.add({ purpose: visitor.purpose.trim() });
                        }
                    };
                }
                saveAddressToAutocomplete(visitor.address);
                closeEditModal();
                loadDashboard();
                loadVisitorsList();
                populateFilterOptions();
                populatePurposeSelects();
                populateGroupTagCompareSelect();
                alert('تبدیلی محفوظ ہو گئی!');
            };
            request.onerror = function (event) {
                console.error('Error updating visitor:', event.target.error);
                alert('تبدیلی محفوظ کرنے میں خرابی پیش آئی: ' + event.target.error.message);
            };
        });
        function updateDepartureDate(context = 'add') {
            const prefix = context === 'edit' ? 'edit-' : '';
            const arrivalDateStr = document.getElementById(`${prefix}arrival-date`).value;
            const stayDurationInput = document.getElementById(`${prefix}stay-duration`);
            const departureDateInput = document.getElementById(`${prefix}departure-date`);
            if (arrivalDateStr && stayDurationInput.value && parseInt(stayDurationInput.value) >= 0) {
                const stayDuration = parseInt(stayDurationInput.value, 10);
                const arrivalDate = new Date(arrivalDateStr);
                const departureDate = new Date(arrivalDate);
                if (stayDuration > 0) {
                    departureDate.setDate(arrivalDate.getDate() + stayDuration - 1);
                } else {
                    departureDate.setDate(arrivalDate.getDate());
                }
                departureDateInput.value = departureDate.toISOString().split('T')[0];
            } else if (stayDurationInput.value && parseInt(stayDurationInput.value) < 0) {
                stayDurationInput.value = 0;
                departureDateInput.value = arrivalDateStr;
            }
        }
        function updateStayDuration(context = 'add') {
            const prefix = context === 'edit' ? 'edit-' : '';
            const arrivalDateStr = document.getElementById(`${prefix}arrival-date`).value;
            const departureDateStr = document.getElementById(`${prefix}departure-date`).value;
            const stayDurationInput = document.getElementById(`${prefix}stay-duration`);
            if (arrivalDateStr && departureDateStr) {
                const arrivalDate = new Date(arrivalDateStr);
                const departureDate = new Date(departureDateStr);
                if (departureDate < arrivalDate) {
                    alert('تاریخ روانگی تاریخ آمد سے پہلے نہیں ہو سکتی۔');
                    departureDateInput.value = arrivalDateStr;
                    stayDurationInput.value = 1;
                    return;
                }
                const diffTime = Math.abs(departureDate.getTime() - arrivalDate.getTime());
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                stayDurationInput.value = diffDays;
            } else {
                stayDurationInput.value = '';
            }
        }
        function loadDashboard() {
            const transaction = db.transaction(['visitors'], 'readonly');
            const objectStore = transaction.objectStore('visitors');
            const request = objectStore.getAll();
            request.onsuccess = function () {
                const visitors = request.result;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const totalVisitors = visitors.length;
                const totalAttendees = visitors.reduce((sum, v) => sum + (v.groupCount || 1), 0);
                const todayVisitors = visitors.filter(v => new Date(v.arrivalDate).setHours(0, 0, 0, 0) === today.getTime()).length;
                const presentVisitors = visitors.filter(v => isPresent(v)).length;
                const presentAttendees = visitors.filter(v => isPresent(v)).reduce((sum, v) => sum + (v.groupCount || 1), 0);
                const totalGroups = visitors.filter(v => v.type === 'گروپ').length;
                const stayDurations = visitors
                    .filter(v => v.departureDate && v.arrivalDate)
                    .map(v => {
                        const arrival = new Date(v.arrivalDate);
                        const departure = new Date(v.departureDate);
                        const diffTime = Math.abs(departure.getTime() - arrival.getTime());
                        return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    })
                    .filter(duration => !isNaN(duration) && duration > 0);
                const averageStay = stayDurations.length > 0 ?
                    Math.round(stayDurations.reduce((a, b) => a + b, 0) / stayDurations.length) : 0;
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const prevMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const thisMonthVisitorsCount = visitors.filter(v => new Date(v.arrivalDate).setHours(0, 0, 0, 0) >= currentMonthStart.getTime()).length;
                const prevMonthVisitorsCount = visitors.filter(v =>
                    new Date(v.arrivalDate).setHours(0, 0, 0, 0) >= prevMonthStart.getTime() &&
                    new Date(v.arrivalDate).setHours(0, 0, 0, 0) < currentMonthStart.getTime()
                ).length;
                const monthlyGrowth = prevMonthVisitorsCount > 0 ?
                    Math.round(((thisMonthVisitorsCount - prevMonthVisitorsCount) / prevMonthVisitorsCount) * 100) : 0;
                document.getElementById('total-visitors').textContent = totalVisitors;
                document.getElementById('total-attendees').textContent = totalAttendees;
                document.getElementById('today-visitors').textContent = todayVisitors;
                document.getElementById('present-visitors').textContent = presentVisitors;
                document.getElementById('present-attendees').textContent = presentAttendees;
                document.getElementById('total-groups').textContent = totalGroups;
                document.getElementById('average-stay').textContent = averageStay;
                document.getElementById('monthly-growth').textContent = monthlyGrowth + '%';
                const recentVisitors = visitors
                    .sort((a, b) => new Date(b.addedDate) - new Date(a.addedDate))
                    .slice(0, 5);
                const recentContainer = document.getElementById('recent-visitors');
                recentContainer.innerHTML = recentVisitors.map(visitor =>
                    createVisitorCard(visitor)).join('');
            };
            request.onerror = function (event) {
                console.error('Error loading dashboard data:', event.target.error);
            };
        }
        function loadVisitorsList() {
            const transaction = db.transaction(['visitors'], 'readonly');
            const objectStore = transaction.objectStore('visitors');
            const request = objectStore.getAll();
            request.onsuccess = function () {
                allVisitors = request.result.sort((a, b) => new Date(b.addedDate) - new Date(a.addedDate));
                filteredVisitors = [...allVisitors];
                visitorsCurrentPage = 1;
                displayVisitors();
            };
            request.onerror = function (event) {
                console.error('Error loading visitors list:', event.target.error);
            };
        }
        function displayVisitors() {
            const container = document.getElementById('visitors-list');
            const startIndex = (visitorsCurrentPage - 1) * recordsPerPageVisitors;
            const endIndex = startIndex + recordsPerPageVisitors;
            const pageVisitors = filteredVisitors.slice(startIndex, endIndex);
            container.innerHTML = pageVisitors.map(visitor => createVisitorCard(visitor, true)).join('');
            updatePagination('visitors');
        }
        function updatePagination(context) {
            let totalPages, currentPage, recordsPerPage, containerId, changePageFunc;
            if (context === 'visitors') {
                totalPages = Math.ceil(filteredVisitors.length / recordsPerPageVisitors);
                currentPage = visitorsCurrentPage;
                recordsPerPage = recordsPerPageVisitors;
                containerId = 'pagination';
                changePageFunc = 'changeVisitorsPage';
            } else if (context === 'reports') {
                totalPages = Math.ceil(reportedVisitors.length / recordsPerPageReports);
                currentPage = reportsCurrentPage;
                recordsPerPage = recordsPerPageReports;
                containerId = 'report-pagination';
                changePageFunc = 'changeReportsPage';
            } else if (context === 'analytics') {
                totalPages = Math.ceil(analyticData.length / recordsPerPageAnalytics);
                currentPage = analyticsCurrentPage;
                recordsPerPage = recordsPerPageAnalytics;
                containerId = 'analytics-pagination';
                changePageFunc = 'changeAnalyticsPage';
            }
            const container = document.getElementById(containerId);
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            let pagination = '';
            if (currentPage > 1) {
                pagination += `<button class="page-btn" onclick="${changePageFunc}(${currentPage - 1})">پچھلا</button>`;
            }
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                pagination += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="${changePageFunc}(${i})">${i}</button>`;
            }
            if (currentPage < totalPages) {
                pagination += `<button class="page-btn" onclick="${changePageFunc}(${currentPage + 1})">اگلا</button>`;
            }
            container.innerHTML = pagination;
        }
        function changeVisitorsPage(page) {
            visitorsCurrentPage = page;
            displayVisitors();
        }
        function changeReportsPage(page) {
            reportsCurrentPage = page;
            generateReports();
        }
        function changeAnalyticsPage(page) {
            analyticsCurrentPage = page;
            loadAnalytics();
        }
        function createVisitorCard(visitor, showActions = false) {
            const isPresentStatus = isVisitorPresent(visitor);
            const isOverstay = isVisitorOverstay(visitor);
            let statusClass = '';
            let statusText = '';
            if (isPresentStatus) {
                statusClass = 'present';
                statusText = 'موجود';
            } else if (isOverstay) {
                statusClass = 'overstay';
                statusText = 'حد سے زیادہ قیام';
            } else {
                statusClass = 'absent';
                statusText = 'غیر موجود';
            }
            const statusBadgeClass = isPresentStatus ? '' : 'absent';
            const groupTag = visitor.groupTag ? `<span class="group-tag">${visitor.groupTag}</span>` : '';
            return `
                <div class="visitor-card ${statusClass}">
                    ${showActions ? `<input type="checkbox" class="visitor-checkbox" onchange="toggleVisitorSelection(${visitor.id})" ${selectedVisitors.has(visitor.id) ? 'checked' : ''}>` : ''}
                    <div class="visitor-header">
                        <div class="visitor-name">${visitor.name} ${groupTag}</div>
                        <div class="visitor-status ${statusBadgeClass}">${statusText}</div>
                    </div>
                    <div class="visitor-details">
                        <div class="visitor-detail"><strong>فون:</strong> ${visitor.phone || 'نہیں'}</div>
                        <div class="visitor-detail"><strong>پتہ:</strong> ${visitor.address || 'نہیں'}</div>
                        <div class="visitor-detail"><strong>آمد:</strong> ${formatDate(visitor.arrivalDate)} ${visitor.arrivalTime || ''}</div>
                        <div class="visitor-detail"><strong>روانگی:</strong> ${visitor.departureDate ? formatDate(visitor.departureDate) : 'طے نہیں'}</div>
                        <div class="visitor-detail"><strong>قسم:</strong> ${visitor.type}</div>
                        <div class="visitor-detail"><strong>افراد:</strong> ${visitor.groupCount || 1}</div>
                        <div class="visitor-detail"><strong>مقصد:</strong> ${visitor.purpose || 'نہیں'}</div>
                        ${visitor.responsiblePerson ? `<div class="visitor-detail"><strong>ذمہ دار:</strong> ${visitor.responsiblePerson}</div>` : ''}
                        ${visitor.specialNotes ? `<div class="visitor-detail"><strong>نوٹس:</strong> ${visitor.specialNotes}</div>` : ''}
                    </div>
                    ${showActions ? `
                        <div class="visitor-actions">
                            ${isPresentStatus ? `<button class="btn btn-sm btn-danger" onclick="checkoutVisitor(${visitor.id})">روانگی درج کریں</button>` : ''}
                            <button class="btn btn-sm btn-warning" onclick="editVisitor(${visitor.id})">تبدیل کریں</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteVisitor(${visitor.id})">حذف کریں</button>
                            <button class="btn btn-sm btn-info" onclick="duplicateVisitor(${visitor.id})">کاپی کریں</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        function toggleVisitorSelection(id) {
            if (selectedVisitors.has(id)) {
                selectedVisitors.delete(id);
            } else {
                selectedVisitors.add(id);
            }
            const bulkActions = document.getElementById('bulk-actions');
            if (selectedVisitors.size > 0) {
                bulkActions.classList.add('active');
            } else {
                bulkActions.classList.remove('active');
            }
        }
        function clearSelection() {
            selectedVisitors.clear();
            document.querySelectorAll('.visitor-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('bulk-actions').classList.remove('active');
        }
        function bulkDelete() {
            if (selectedVisitors.size === 0) {
                alert('حذف کرنے کے لیے کوئی زائر منتخب نہیں کیا گیا ہے۔');
                return;
            }
            if (confirm(`کیا آپ واقعی ${selectedVisitors.size} منتخب کردہ زائرین کو حذف کرنا چاہتے ہیں؟`)) {
                const transaction = db.transaction(['visitors'], 'readwrite');
                const objectStore = transaction.objectStore('visitors');
                selectedVisitors.forEach(id => {
                    objectStore.delete(id);
                });
                transaction.oncomplete = function () {
                    clearSelection();
                    loadDashboard();
                    loadVisitorsList();
                    alert('منتخب کردہ زائرین حذف کر دیے گئے!');
                };
                transaction.onerror = function (event) {
                    console.error('Bulk delete failed:', event.target.error);
                    alert('منتخب کردہ زائرین کو حذف کرنے میں خرابی پیش آئی: ' + event.target.error.message);
                };
            }
        }
        function bulkExport() {
            if (selectedVisitors.size === 0) {
                alert('ایکسپورٹ کرنے کے لیے کوئی زائر منتخب نہیں کیا گیا ہے۔');
                return;
            }
            const selectedData = allVisitors.filter(v => selectedVisitors.has(v.id));
            exportVisitorsData(selectedData, 'منتخب_کردہ_زائرین');
        }
        function isVisitorPresent(visitor) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const arrival = new Date(visitor.arrivalDate);
            arrival.setHours(0, 0, 0, 0);
            const departure = visitor.departureDate ? new Date(visitor.departureDate) : null;
            if (departure) {
                departure.setHours(0, 0, 0, 0);
                return today >= arrival && today <= departure;
            } else {
                return today >= arrival;
            }
        }
        function isVisitorOverstay(visitor) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const departure = visitor.departureDate ? new Date(visitor.departureDate) : null;
            return departure && today > departure && isVisitorPresent(visitor);
        }
        function isPresent(visitor) {
            return isVisitorPresent(visitor);
        }
        function checkoutVisitor(id) {
            if (confirm('کیا آپ اس زائر کی روانگی کی تاریخ آج کی تاریخ پر سیٹ کرنا چاہتے ہیں؟')) {
                const transaction = db.transaction(['visitors'], 'readwrite');
                const objectStore = transaction.objectStore('visitors');
                const request = objectStore.get(id);
                request.onsuccess = function () {
                    const visitor = request.result;
                    if (visitor) {
                        visitor.departureDate = new Date().toISOString().split('T')[0];
                        const putRequest = objectStore.put(visitor);
                        putRequest.onsuccess = function () {
                            loadDashboard();
                            loadVisitorsList();
                            alert('روانگی کی تاریخ کامیابی سے درج کی گئی!');
                        };
                        putRequest.onerror = function (event) {
                            console.error('Error updating departure date:', event.target.error);
                            alert('روانگی کی تاریخ درج کرنے میں خرابی پیش آئی: ' + event.target.error.message);
                        };
                    }
                };
                request.onerror = function (event) {
                    console.error('Error fetching visitor for checkout:', event.target.error);
                };
            }
        }
        function formatDate(dateStr) {
            if (!dateStr) return '--';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return '--';
            return date.toLocaleDateString('ur-PK');
        }
        function globalSearch() {
            const searchTerm = document.getElementById('global-search').value.toLowerCase();
            if (!searchTerm) {
                filteredVisitors = [...allVisitors];
            } else {
                filteredVisitors = allVisitors.filter(visitor =>
                    visitor.name.toLowerCase().includes(searchTerm) ||
                    (visitor.phone && visitor.phone.toLowerCase().includes(searchTerm)) ||
                    (visitor.address && visitor.address.toLowerCase().includes(searchTerm)) ||
                    (visitor.purpose && visitor.purpose.toLowerCase().includes(searchTerm)) ||
                    (visitor.groupTag && visitor.groupTag.toLowerCase().includes(searchTerm)) ||
                    (visitor.responsiblePerson && visitor.responsiblePerson.toLowerCase().includes(searchTerm))
                );
            }
            visitorsCurrentPage = 1;
            displayVisitors();
        }
        function toggleAdvancedFilters() {
            const filters = document.getElementById('advanced-filters');
            const toggle = document.querySelector('.filter-toggle');
            if (filters.style.display === 'none' || !filters.style.display) {
                filters.style.display = 'block';
                toggle.textContent = 'سادہ فلٹرز';
            } else {
                filters.style.display = 'none';
                toggle.textContent = 'تفصیلی فلٹرز';
            }
        }
        function filterVisitors() {
            const dateFrom = document.getElementById('filter-date-from').value;
            const dateTo = document.getElementById('filter-date-to').value;
            const type = document.getElementById('filter-type').value;
            const status = document.getElementById('filter-status').value;
            const city = document.getElementById('filter-city').value;
            const purpose = document.getElementById('filter-purpose').value;
            filteredVisitors = allVisitors.filter(visitor => {
                let match = true;
                if (dateFrom && visitor.arrivalDate < dateFrom) match = false;
                if (dateTo && visitor.arrivalDate > dateTo) match = false;
                if (type && visitor.type !== type) match = false;
                if (city && visitor.address && !visitor.address.includes(city)) match = false;
                if (purpose && visitor.purpose !== purpose) match = false;
                if (status) {
                    const present = isVisitorPresent(visitor);
                    const overstay = isVisitorOverstay(visitor);
                    if (status === 'present' && !present) match = false;
                    if (status === 'absent' && present) match = false;
                    if (status === 'overstay' && !overstay) match = false;
                }
                return match;
            });
            visitorsCurrentPage = 1;
            displayVisitors();
        }
        function clearAllFilters() {
            document.getElementById('global-search').value = '';
            document.getElementById('filter-date-from').value = '';
            document.getElementById('filter-date-to').value = '';
            document.getElementById('filter-type').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-city').value = '';
            document.getElementById('filter-purpose').value = '';
            filteredVisitors = [...allVisitors];
            visitorsCurrentPage = 1;
            displayVisitors();
        }
        function populateFilterOptions() {
            const transaction = db.transaction(['visitors'], 'readonly');
            const objectStore = transaction.objectStore('visitors');
            const request = objectStore.getAll();
            request.onsuccess = function () {
                const visitors = request.result;
                const cities = [...new Set(visitors.map(v => {
                    if (v.address) {
                        const parts = v.address.split('،').map(p => p.trim());
                        return parts[1] || parts[0];
                    }
                    return '';
                }).filter(Boolean))];
                const purposes = [...new Set(visitors.map(v => v.purpose).filter(Boolean))];
                populateSelect('filter-city', cities);
                populateSelect('filter-purpose', purposes);
                populatePurposeSelects();
            };
            request.onerror = function (event) {
                console.error('Error populating filter options:', event.target.error);
            };
        }
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            select.innerHTML = select.querySelector('option') ? select.querySelector('option').outerHTML : '';
            options.sort().forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            select.value = currentValue;
        }
        function editVisitor(id) {
            const transaction = db.transaction(['visitors'], 'readonly');
            const objectStore = transaction.objectStore('visitors');
            const request = objectStore.get(id);
            request.onsuccess = function () {
                const visitor = request.result;
                if (!visitor) {
                    alert('زائر نہیں ملا۔');
                    return;
                }
                currentEditId = id;
                document.getElementById('edit-visitor-name').value = visitor.name;
                document.getElementById('edit-visitor-phone').value = visitor.phone;
                document.getElementById('edit-visitor-address').value = visitor.address;
                document.getElementById('edit-arrival-date').value = visitor.arrivalDate;
                document.getElementById('edit-arrival-time').value = visitor.arrivalTime;
                document.getElementById('edit-departure-date').value = visitor.departureDate;
                document.getElementById('edit-visitor-type').value = visitor.type;
                document.getElementById('edit-group-count').value = visitor.groupCount;
                document.getElementById('edit-visit-purpose').value = visitor.purpose;
                document.getElementById('edit-group-tag').value = visitor.groupTag || '';
                document.getElementById('edit-responsible-person').value = visitor.responsiblePerson || '';
                document.getElementById('edit-special-notes').value = visitor.specialNotes || '';
                if (visitor.arrivalDate && visitor.departureDate) {
                    const arrival = new Date(visitor.arrivalDate);
                    const departure = new Date(visitor.departureDate);
                    const diffTime = Math.abs(departure.getTime() - arrival.getTime());
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    document.getElementById('edit-stay-duration').value = diffDays;
                } else {
                    document.getElementById('edit-stay-duration').value = '';
                }
                toggleGroupCount('edit');
                document.getElementById('edit-modal').style.display = 'flex';
            };
            request.onerror = function (event) {
                console.error('Error fetching visitor for edit:', event.target.error);
                alert('زائر کی تفصیلات لوڈ کرنے میں خرابی پیش آئی۔');
            };
        }
        function duplicateVisitor(id) {
            const transaction = db.transaction(['visitors'], 'readonly');
            const objectStore = transaction.objectStore('visitors');
            const request = objectStore.get(id);
            request.onsuccess = function () {
                const visitor = request.result;
                if (!visitor) {
                    alert('کاپی کرنے کے لیے زائر نہیں ملا۔');
                    return;
                }
                const newVisitor = {
                    ...visitor,
                    id: Date.now(),
                    name: visitor.name + ' (کاپی)',
                    addedDate: new Date().toISOString()
                };
                const addTransaction = db.transaction(['visitors'], 'readwrite');
                const addObjectStore = addTransaction.objectStore('visitors');
                const addRequest = addObjectStore.add(newVisitor);
                addRequest.onsuccess = function () {
                    loadDashboard();
                    loadVisitorsList();
                    alert('زائر کامیابی سے کاپی ہو گیا!');
                };
                addRequest.onerror = function (event) {
                    console.error('Error duplicating visitor:', event.target.error);
                    alert('زائر کو کاپی کرنے میں خرابی پیش آئی: ' + event.target.error.message);
                };
            };
            request.onerror = function (event) {
                console.error('Error fetching visitor for duplication:', event.target.error);
            };
        }
        function deleteVisitor(id) {
            if (confirm('کیا آپ واقعی اس زائر کو حذف کرنا چاہتے ہیں؟')) {
                const transaction = db.transaction(['visitors'], 'readwrite');
                const objectStore = transaction.objectStore('visitors');
                const request = objectStore.delete(id);
                request.onsuccess = function () {
                    loadDashboard();
                    loadVisitorsList();
                    alert('زائر حذف کر دیا گیا!');
                };
                request.onerror = function (event) {
                    console.error('Error deleting visitor:', event.target.error);
                    alert('زائر کو حذف کرنے میں خرابی پیش آئی: ' + event.target.error.message);
                };
            }
        }
        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            document.getElementById('edit-address-suggestions').style.display = 'none';
            currentEditId = null;
        }
        function clearReportFilters() {
            document.getElementById('report-date-from').value = '';
            document.getElementById('report-date-to').value = '';
            document.getElementById('report-type').value = 'all';
            document.getElementById('group-by').value = 'none';
            generateReports();
        }
        function loadReports() {
            generateReports();
        }
        function generateReports() {
            const transaction = db.transaction(['visitors'], 'readonly');
            const objectStore = transaction.objectStore('visitors');
            const request = objectStore.getAll();
            request.onsuccess = function () {
                let visitors = request.result.sort((a, b) => {
                    const dateA = new Date(a.arrivalDate + 'T' + (a.arrivalTime || '00:00'));
                    const dateB = new Date(b.arrivalDate + 'T' + (b.arrivalTime || '00:00'));
                    return dateB - dateA;
                });
                const dateFrom = document.getElementById('report-date-from')?.value;
                const dateTo = document.getElementById('report-date-to')?.value;
                const reportType = document.getElementById('report-type')?.value || 'all';
                const groupBy = document.getElementById('group-by')?.value || 'none';
                if (dateFrom) visitors = visitors.filter(v => v.arrivalDate >= dateFrom);
                if (dateTo) visitors = visitors.filter(v => v.arrivalDate <= dateTo);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const nextSevenDays = new Date(today);
                nextSevenDays.setDate(today.getDate() + 7);
                nextSevenDays.setHours(23, 59, 59, 999);
                let reportContent = '';
                switch (reportType) {
                    case 'daily-arrivals':
                        reportedVisitors = visitors.filter(v => new Date(v.arrivalDate).setHours(0, 0, 0, 0) === today.getTime());
                        reportContent = generateBasicReport(reportedVisitors);
                        break;
                    case 'daily-departures':
                        reportedVisitors = visitors.filter(v => new Date(v.departureDate).setHours(0, 0, 0, 0) === today.getTime());
                        reportContent = generateBasicReport(reportedVisitors);
                        break;
                    case 'currently-present':
                        reportedVisitors = visitors.filter(v => isVisitorPresent(v));
                        reportContent = generateBasicReport(reportedVisitors);
                        break;
                    case 'upcoming-activity':
                        reportedVisitors = visitors.filter(v => {
                            const arrivalDate = new Date(v.arrivalDate);
                            arrivalDate.setHours(0, 0, 0, 0);
                            const departureDate = v.departureDate ? new Date(v.departureDate) : null;
                            if (departureDate) departureDate.setHours(0, 0, 0, 0);
                            return (arrivalDate >= today && arrivalDate <= nextSevenDays) ||
                                (departureDate && departureDate >= today && departureDate <= nextSevenDays);
                        });
                        reportContent = generateBasicReport(reportedVisitors);
                        break;
                    case 'special-needs':
                        reportedVisitors = visitors.filter(v => v.specialNotes && isVisitorPresent(v));
                        reportContent = generateBasicReport(reportedVisitors);
                        break;
                    case 'overstay':
                        reportedVisitors = visitors.filter(v => isVisitorOverstay(v));
                        reportContent = generateBasicReport(reportedVisitors);
                        break;
                    case 'period-summary':
                        reportedVisitors = visitors;
                        reportContent = generatePeriodSummary(reportedVisitors);
                        break;
                    case 'purpose-breakdown':
                        reportedVisitors = visitors;
                        reportContent = generatePurposeBreakdown(reportedVisitors);
                        break;
                    case 'geographic-breakdown':
                        reportedVisitors = visitors;
                        reportContent = generateGeographicBreakdown(reportedVisitors);
                        break;
                    case 'all':
                    case 'custom':
                    default:
                        reportedVisitors = visitors;
                        if (groupBy === 'none') {
                            reportContent = generateBasicReport(reportedVisitors);
                        } else {
                            reportContent = generateGroupedReport(reportedVisitors, groupBy);
                        }
                        break;
                }
                const container = document.getElementById('reports-container');
                container.innerHTML = reportContent;
                updatePagination('reports');
            };
            request.onerror = function (event) {
                console.error('Error generating reports:', event.target.error);
            };
        }
        function displayReportsContent(visitors, groupBy) {
            const container = document.getElementById('reports-container');
            let content = '';
            const startIndex = (reportsCurrentPage - 1) * recordsPerPageReports;
            const endIndex = startIndex + recordsPerPageReports;
            const pageVisitors = visitors.slice(startIndex, endIndex);
            if (groupBy === 'none') {
                content = generateBasicReport(pageVisitors);
            } else {
                content = generateGroupedReport(pageVisitors, groupBy);
            }
            container.innerHTML = content;
            updatePagination('reports');
        }
        function generateBasicReport(visitors) {
            const totalVisitors = visitors.length;
            const totalAttendees = visitors.reduce((sum, v) => sum + (v.groupCount || 1), 0);
            const presentVisitors = visitors.filter(v => isVisitorPresent(v)).length;
            const presentAttendees = visitors.filter(v => isVisitorPresent(v)).reduce((sum, v) => sum + (v.groupCount || 1), 0);
            let html = `
                <div class="stats-grid">
                    <div class="stat-card"><h3>${totalVisitors}</h3><p>کل زائرین</p></div>
                    <div class="stat-card"><h3>${totalAttendees}</h3><p>کل حاضری</p></div>
                    <div class="stat-card"><h3>${presentVisitors}</h3><p>موجودہ زائرین</p></div>
                    <div class="stat-card"><h3>${presentAttendees}</h3><p>موجودہ حاضری</p></div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>نام</th>
                            <th>فون</th>
                            <th>پتہ</th>
                            <th>آمد</th>
                            <th>روانگی</th>
                            <th>قسم</th>
                            <th>افراد</th>
                            <th>مقصد</th>
                            <th>موجودگی</th>
                            <th>نوٹس</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            if (visitors.length === 0) {
                html += `<tr><td colspan="10" style="text-align: center;">کوئی ڈیٹا دستیاب نہیں</td></tr>`;
            } else {
                visitors.forEach(visitor => {
                    html += `
                        <tr>
                            <td>${visitor.name}</td>
                            <td>${visitor.phone || '--'}</td>
                            <td>${visitor.address || '--'}</td>
                            <td>${formatDate(visitor.arrivalDate)} ${visitor.arrivalTime || ''}</td>
                            <td>${visitor.departureDate ? formatDate(visitor.departureDate) : '--'}</td>
                            <td>${visitor.type}</td>
                            <td>${visitor.groupCount || 1}</td>
                            <td>${visitor.purpose || '--'}</td>
                            <td>${isVisitorPresent(visitor) ? 'موجود' : (isVisitorOverstay(visitor) ? 'حد سے زیادہ قیام' : 'غیر موجود')}</td>
                            <td>${visitor.specialNotes || '--'}</td>
                        </tr>
                    `;
                });
            }
            html += '</tbody></table>';
            return html;
        }
        function generateGroupedReport(visitors, groupBy) {
            const groups = {};
            visitors.forEach(visitor => {
                let key = '';
                switch (groupBy) {
                    case 'city':
                        key = visitor.address?.split('،').pop()?.trim() || 'نامعلوم';
                        break;
                    case 'purpose':
                        key = visitor.purpose || 'نامعلوم';
                        break;
                    case 'type':
                        key = visitor.type;
                        break;
                    case 'month':
                        const date = new Date(visitor.arrivalDate);
                        key = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
                        break;
                    default:
                        key = 'نامعلوم';
                }
                if (!groups[key]) {
                    groups[key] = [];
                }
                groups[key].push(visitor);
            });
            let html = '<div class="reports-grouped-section">';
            if (Object.keys(groups).length === 0) {
                html += `<p style="text-align: center;">کوئی ڈیٹا دستیاب نہیں</p>`;
            } else {
                Object.entries(groups).sort().forEach(([groupName, groupVisitors]) => {
                    const totalAttendees = groupVisitors.reduce((sum, v) => sum + (v.groupCount || 1), 0);
                    html += `
                        <div class="reports-section">
                            <h4>${groupName} (${groupVisitors.length} زائرین، ${totalAttendees} حاضری)</h4>
                            <table class="data-table" style="margin-bottom: 20px;">
                                <thead>
                                    <tr>
                                        <th>نام</th>
                                        <th>فون</th>
                                        <th>آمد</th>
                                        <th>روانگی</th>
                                        <th>افراد</th>
                                        <th>مقصد</th>
                                        <th>موجودگی</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${groupVisitors.map(v => `
                                        <tr>
                                            <td>${v.name}</td>
                                            <td>${v.phone || '--'}</td>
                                            <td>${formatDate(v.arrivalDate)} ${v.arrivalTime || ''}</td>
                                            <td>${v.departureDate ? formatDate(v.departureDate) : '--'}</td>
                                            <td>${v.groupCount || 1}</td>
                                            <td>${v.purpose || '--'}</td>
                                            <td>${isVisitorPresent(v) ? 'موجود' : (isVisitorOverstay(v) ? 'حد سے زیادہ قیام' : 'غیر موجود')}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                });
            }
            html += '</div>';
            return html;
        }
        function generatePeriodSummary(visitors) {
            const totalVisitors = visitors.length;
            const totalAttendees = visitors.reduce((sum, v) => sum + (v.groupCount || 1), 0);
            const totalGroups = visitors.filter(v => v.type === 'گروپ').length;
            const totalIndividuals = visitors.filter(v => v.type === 'فرد').length;
            const stayDurations = visitors
                .filter(v => v.departureDate && v.arrivalDate)
                .map(v => {
                    const arrival = new Date(v.arrivalDate);
                    const departure = new Date(v.departureDate);
                    const diffTime = Math.abs(departure.getTime() - arrival.getTime());
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                })
                .filter(duration => !isNaN(duration) && duration > 0);
            const averageStay = stayDurations.length > 0 ?
                Math.round(stayDurations.reduce((a, b) => a + b, 0) / stayDurations.length) : 0;
            const groupVisitors = visitors.filter(v => v.type === 'گروپ');
            const totalGroupSize = groupVisitors.reduce((sum, v) => sum + (v.groupCount || 1), 0);
            const averageGroupSize = groupVisitors.length > 0 ?
                Math.round(totalGroupSize / groupVisitors.length) : 0;
            return `
                <div class="reports-section">
                    <h3>مدت کا خلاصہ</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>اشاریہ</th>
                                <th>تعداد</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>کل زائرین</td><td>${totalVisitors}</td></tr>
                            <tr><td>کل حاضری (افراد)</td><td>${totalAttendees}</td></tr>
                            <tr><td>کل گروپس</td><td>${totalGroups}</td></tr>
                            <tr><td>کل انفرادی زائرین</td><td>${totalIndividuals}</td></tr>
                            <tr><td>اوسط قیام (دن)</td><td>${averageStay}</td></tr>
                            <tr><td>اوسط گروپ سائز</td><td>${averageGroupSize}</td></tr>
                        </tbody>
                    </table>
                </div>
            `;
        }
        function generatePurposeBreakdown(visitors) {
            const purposeCount = {};
            visitors.forEach(v => {
                const purpose = v.purpose || 'نامعلوم';
                purposeCount[purpose] = (purposeCount[purpose] || 0) + (v.groupCount || 1);
            });
            const totalAttendees = visitors.reduce((sum, v) => sum + (v.groupCount || 1), 0);
            let html = `
                <div class="reports-section">
                    <h3>مقصد کے لحاظ سے تقسیم</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>مقصد</th>
                                <th>کل افراد</th>
                                <th>فیصد</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            if (Object.keys(purposeCount).length === 0) {
                html += `<tr><td colspan="3" style="text-align: center;">کوئی ڈیٹا دستیاب نہیں</td></tr>`;
            } else {
                Object.entries(purposeCount)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([purpose, count]) => {
                        const percentage = totalAttendees > 0 ? ((count / totalAttendees) * 100).toFixed(1) : '0';
                        html += `
                            <tr>
                                <td>${purpose}</td>
                                <td>${count}</td>
                                <td>${percentage}%</td>
                            </tr>
                        `;
                    });
            }
            html += '</tbody></table></div>';
            return html;
        }
        function generateGeographicBreakdown(visitors) {
            const cityCount = {};
            const provinceCount = {};
            visitors.forEach(v => {
                const members = v.groupCount || 1;
                const city = v.address?.split('،')[0]?.trim() || 'نامعلوم';
                const province = getProvince(v.address?.split('،').pop()?.trim());
                cityCount[city] = (cityCount[city] || 0) + members;
                provinceCount[province] = (provinceCount[province] || 0) + members;
            });
            const totalAttendees = visitors.reduce((sum, v) => sum + (v.groupCount || 1), 0);
            let html = `
                <div class="reports-section">
                    <h3>جغرافیائی تقسیم (صوبے کے لحاظ سے)</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>صوبہ</th>
                                <th>کل افراد</th>
                                <th>فیصد</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            if (Object.keys(provinceCount).length === 0) {
                html += `<tr><td colspan="3" style="text-align: center;">کوئی ڈیٹا دستیاب نہیں</td></tr>`;
            } else {
                Object.entries(provinceCount)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([province, count]) => {
                        const percentage = totalAttendees > 0 ? ((count / totalAttendees) * 100).toFixed(1) : '0';
                        html += `
                            <tr>
                                <td>${province}</td>
                                <td>${count}</td>
                                <td>${percentage}%</td>
                            </tr>
                        `;
                    });
            }
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="reports-section">
                    <h3>جغرافیائی تقسیم (شہر کے لحاظ سے - ٹاپ 10)</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>شہر</th>
                                <th>کل افراد</th>
                                <th>فیصد</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            if (Object.keys(cityCount).length === 0) {
                html += `<tr><td colspan="3" style="text-align: center;">کوئی ڈیٹا دستیاب نہیں</td></tr>`;
            } else {
                Object.entries(cityCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10)
                    .forEach(([city, count]) => {
                        const percentage = totalAttendees > 0 ? ((count / totalAttendees) * 100).toFixed(1) : '0';
                        html += `
                            <tr>
                                <td>${city}</td>
                                <td>${count}</td>
                                <td>${percentage}%</td>
                            </tr>
                        `;
                    });
            }
            html += '</tbody></table></div>';
            return html;
        }
        function getProvince(addressPart) {
            if (!addressPart) return 'نامعلوم';
            const normalized = addressPart.toLowerCase();
            const provinceMap = {
                'پنجاب': ['lahore', 'لاہور', 'faisalabad', 'فیصل آباد', 'rawalpindi', 'راولپنڈی', 'multan', 'ملتان', 'gujranwala', 'گوجرانوالہ', 'sialkot', 'سیالکوٹ', 'bahawalpur', 'بہاولپور', 'sargodha', 'سرگودھا', 'gujrat', 'گجرات', 'jhelum', 'جہلم', 'chakwal', 'چکوال', 'mianwali', 'میانوالی'],
                'سندھ': ['karachi', 'کراچی', 'hyderabad', 'حیدرآباد', 'sukkur', 'سکھر', 'larkana', 'لاڑکانہ', 'mirpur khas', 'میرپور خاص'],
                'خیبر پختونخوا': ['peshawar', 'پشاور', 'mardan', 'مردان', 'abbottabad', 'ایبٹ آباد', 'swat', 'سوات', 'kohat', 'کوہاٹ'],
                'بلوچستان': ['quetta', 'کوئٹہ', 'gwadar', 'گوادر', 'khuzdar', 'خضدار'],
                'اسلام آباد': ['islamabad', 'اسلام آباد'],
                'گلگت بلتستان': ['gilgit', 'گلگت', 'skardu', 'سکردو'],
                'آزاد کشمیر': ['muzaffarabad', 'مظفرآباد', 'mirpur', 'میرپور']
            };
            for (const province in provinceMap) {
                if (provinceMap[province].some(c => normalized.includes(c))) {
                    return province;
                }
            }
            return 'دیگر';
        }
        function resetAnalyticsFilters() {
            document.getElementById('analytics-date-from').value = '';
            document.getElementById('analytics-date-to').value = '';
            document.getElementById('analytics-type-filter').value = 'all';
            document.getElementById('compare-from1').value = '';
            document.getElementById('compare-to1').value = '';
            document.getElementById('compare-from2').value = '';
            document.getElementById('compare-to2').value = '';
            document.getElementById('group-tag-compare').value = '';
            loadAnalytics();
        }
        function destroyAllCharts() {
            Object.values(analyticsCharts).forEach(chart => {
                if (chart) {
                    chart.destroy();
                }
            });
            analyticsCharts = {};
        }
        function renderAllAnalyticsCharts(visitors) {
            const isDarkMode = document.body.classList.contains('dark');
            const fontColor = isDarkMode ? '#e0e0e0' : '#333';
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const chartColors = ['#5b8ad2', '#4CAF50', '#fdd835', '#ef5350', '#17a2b8', '#663399', '#ff9800'];
            destroyAllCharts();
            const occupancyData = {};
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            visitors.forEach(v => {
                const arrival = new Date(v.arrivalDate);
                arrival.setHours(0, 0, 0, 0);
                const departure = v.departureDate ? new Date(v.departureDate) : null;
                if (departure) departure.setHours(0, 0, 0, 0);
                let currentDate = new Date(arrival);
                while (currentDate.getTime() <= (departure ? departure.getTime() : today.getTime())) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    occupancyData[dateStr] = (occupancyData[dateStr] || 0) + (v.groupCount || 1);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            });
            const sortedOccupancyDates = Object.keys(occupancyData).sort();
            const occupancyLabels = sortedOccupancyDates.map(date => formatDate(date));
            const occupancyValues = sortedOccupancyDates.map(date => occupancyData[date]);
            const provinceCount = visitors.reduce((acc, v) => {
                const province = getProvince(v.address?.split('،').pop()?.trim());
                acc[province] = (acc[province] || 0) + (v.groupCount || 1);
                return acc;
            }, {});
            const purposeCount = visitors.reduce((acc, v) => {
                const purpose = v.purpose || 'نامعلوم';
                acc[purpose] = (acc[purpose] || 0) + 1;
                return acc;
            }, {});
            const typeCount = visitors.reduce((acc, v) => {
                acc[v.type] = (acc[v.type] || 0) + 1;
                return acc;
            }, {});
            const stayDurationBuckets = { '1-3 دن': 0, '4-7 دن': 0, '8-14 دن': 0, '15+ دن': 0 };
            visitors.forEach(v => {
                if (v.arrivalDate && v.departureDate) {
                    const arrival = new Date(v.arrivalDate);
                    const departure = new Date(v.departureDate);
                    const diffDays = Math.ceil(Math.abs(departure - arrival) / (1000 * 60 * 60 * 24)) + 1;
                    if (diffDays >= 1 && diffDays <= 3) stayDurationBuckets['1-3 دن']++;
                    else if (diffDays >= 4 && diffDays <= 7) stayDurationBuckets['4-7 دن']++;
                    else if (diffDays >= 8 && diffDays <= 14) stayDurationBuckets['8-14 دن']++;
                    else if (diffDays >= 15) stayDurationBuckets['15+ دن']++;
                }
            });
            const monthlyArrivals = {};
            visitors.forEach(v => {
                const date = new Date(v.arrivalDate);
                const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyArrivals[yearMonth] = (monthlyArrivals[yearMonth] || 0) + (v.groupCount || 1);
            });
            const sortedMonths = Object.keys(monthlyArrivals).sort();
            const monthlyLabels = sortedMonths;
            const monthlyValues = sortedMonths.map(month => monthlyArrivals[month]);
            const purposeTrends = {};
            const uniquePurposes = [...new Set(visitors.map(v => v.purpose).filter(Boolean))];
            visitors.forEach(v => {
                const month = new Date(v.arrivalDate).toISOString().slice(0, 7);
                if (!purposeTrends[month]) purposeTrends[month] = {};
                if (v.purpose) purposeTrends[month][v.purpose] = (purposeTrends[month][v.purpose] || 0) + 1;
            });
            const sortedMonthsForPurpose = Object.keys(purposeTrends).sort();
            const purposeTrendDatasets = uniquePurposes.map((purpose, index) => {
                return {
                    label: purpose,
                    data: sortedMonthsForPurpose.map(month => purposeTrends[month][purpose] || 0),
                    borderColor: chartColors[index % chartColors.length],
                    fill: false,
                    tension: 0.1
                };
            });
            const dailyArrivals = {
                'اتوار': 0, 'سوموار': 0, 'منگل': 0, 'بدھ': 0, 'جمعرات': 0, 'جمعہ': 0, 'ہفتہ': 0
            };
            const dayNames = ['اتوار', 'سوموار', 'منگل', 'بدھ', 'جمعرات', 'جمعہ', 'ہفتہ'];
            visitors.forEach(v => {
                const dayOfWeek = new Date(v.arrivalDate).getDay();
                dailyArrivals[dayNames[dayOfWeek]] = (dailyArrivals[dayNames[dayOfWeek]] || 0) + (v.groupCount || 1);
            });
            const dailyLabels = dayNames;
            const dailyValues = dayNames.map(day => dailyArrivals[day]);
            const hourlyArrivals = {};
            for (let i = 0; i < 24; i++) {
                hourlyArrivals[String(i).padStart(2, '0') + ':00'] = 0;
            }
            visitors.forEach(v => {
                if (v.arrivalTime) {
                    const hour = v.arrivalTime.split(':')[0];
                    hourlyArrivals[hour + ':00'] = (hourlyArrivals[hour + ':00'] || 0) + (v.groupCount || 1);
                }
            });
            const hourlyLabels = Object.keys(hourlyArrivals).sort();
            const hourlyValues = hourlyLabels.map(hour => hourlyArrivals[hour]);
            analyticsCharts.visitorsOverTime = new Chart(document.getElementById('visitorsOverTimeChart'), {
                type: 'line',
                data: { labels: occupancyLabels, datasets: [{ label: 'کل افراد موجود', data: occupancyValues, borderColor: 'var(--primary-color)', tension: 0.1, fill: true, backgroundColor: 'rgba(44, 90, 160, 0.2)' }] },
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { color: fontColor }, grid: { color: gridColor } }, x: { ticks: { color: fontColor }, grid: { color: gridColor } } }, plugins: { legend: { labels: { color: fontColor } } } }
            });
            analyticsCharts.provinceDistribution = new Chart(document.getElementById('provinceDistributionChart'), {
                type: 'doughnut',
                data: { labels: Object.keys(provinceCount), datasets: [{ data: Object.values(provinceCount), backgroundColor: chartColors }] },
                options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: fontColor } } } }
            });
            analyticsCharts.purposeDistribution = new Chart(document.getElementById('purposeDistributionChart'), {
                type: 'bar',
                data: { labels: Object.keys(purposeCount), datasets: [{ label: 'زائرین کی تعداد', data: Object.values(purposeCount), backgroundColor: chartColors[1] }] },
                options: { indexAxis: 'y', responsive: true, scales: { y: { ticks: { color: fontColor }, grid: { color: gridColor } }, x: { beginAtZero: true, ticks: { color: fontColor }, grid: { color: gridColor } } }, plugins: { legend: { display: false } } }
            });
            analyticsCharts.visitorType = new Chart(document.getElementById('visitorTypeChart'), {
                type: 'pie',
                data: { labels: Object.keys(typeCount), datasets: [{ data: Object.values(typeCount), backgroundColor: [chartColors[0], chartColors[3]] }] },
                options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: fontColor } } } }
            });
            analyticsCharts.stayDuration = new Chart(document.getElementById('stayDurationChart'), {
                type: 'bar',
                data: { labels: Object.keys(stayDurationBuckets), datasets: [{ label: 'زائرین کی تعداد', data: Object.values(stayDurationBuckets), backgroundColor: chartColors[4] }] },
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { color: fontColor }, grid: { color: gridColor } }, x: { ticks: { color: fontColor }, grid: { color: gridColor } } }, plugins: { legend: { display: false } } }
            });
            analyticsCharts.monthlyArrivals = new Chart(document.getElementById('monthlyArrivalsChart'), {
                type: 'bar',
                data: { labels: monthlyLabels, datasets: [{ label: 'کل افراد کی آمد', data: monthlyValues, backgroundColor: chartColors[5] }] },
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { color: fontColor }, grid: { color: gridColor } }, x: { ticks: { color: fontColor }, grid: { color: gridColor } } }, plugins: { legend: { display: false } } }
            });
            analyticsCharts.purposeTrend = new Chart(document.getElementById('purposeTrendChart'), {
                type: 'line',
                data: { labels: sortedMonthsForPurpose, datasets: purposeTrendDatasets },
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { color: fontColor }, grid: { color: gridColor } }, x: { ticks: { color: fontColor }, grid: { color: gridColor } } }, plugins: { legend: { labels: { color: fontColor } } } }
            });
            analyticsCharts.dailyArrivals = new Chart(document.getElementById('dailyArrivalsChart'), {
                type: 'bar',
                data: { labels: dailyLabels, datasets: [{ label: 'کل افراد کی آمد', data: dailyValues, backgroundColor: chartColors[6] }] },
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { color: fontColor }, grid: { color: gridColor } }, x: { ticks: { color: fontColor }, grid: { color: gridColor } } }, plugins: { legend: { display: false } } }
            });
            analyticsCharts.hourlyArrivals = new Chart(document.getElementById('hourlyArrivalsChart'), {
                type: 'bar',
                data: { labels: hourlyLabels, datasets: [{ label: 'کل افراد کی آمد', data: hourlyValues, backgroundColor: chartColors[0] }] },
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { color: fontColor }, grid: { color: gridColor } }, x: { ticks: { color: fontColor }, grid: { color: gridColor } } }, plugins: { legend: { display: false } } }
            });
        }
        function loadAnalytics() {
            const dateFrom = document.getElementById('analytics-date-from').value;
            const dateTo = document.getElementById('analytics-date-to').value;
            const typeFilter = document.getElementById('analytics-type-filter').value;
            const compareFrom1 = document.getElementById('compare-from1').value;
            const compareTo1 = document.getElementById('compare-to1').value;
            const compareFrom2 = document.getElementById('compare-from2').value;
            const compareTo2 = document.getElementById('compare-to2').value;
            const groupTagCompareSelect = document.getElementById('group-tag-compare');
            const selectedGroupTags = Array.from(groupTagCompareSelect.selectedOptions).map(option => option.value);
            const transaction = db.transaction(['visitors'], 'readonly');
            const objectStore = transaction.objectStore('visitors');
            const request = objectStore.getAll();
            request.onsuccess = function () {
                let visitors = request.result;
                let filteredForChartsAndTables = visitors;
                if (dateFrom) filteredForChartsAndTables = filteredForChartsAndTables.filter(v => v.arrivalDate >= dateFrom);
                if (dateTo) filteredForChartsAndTables = filteredForChartsAndTables.filter(v => v.arrivalDate <= dateTo);
                if (typeFilter !== 'all') filteredForChartsAndTables = filteredForChartsAndTables.filter(v => v.type === typeFilter);
                analyticData = filteredForChartsAndTables;
                destroyAllCharts();
                document.getElementById('analytics-tables').innerHTML = '';
                document.getElementById('comparative-analysis-content').innerHTML = '';
                if (analyticData.length === 0) {
                    document.getElementById('analytics-charts').innerHTML = '<p style="text-align:center;">اس مدت کے لیے کوئی ڈیٹا دستیاب نہیں۔</p>';
                    ['analytics-peak-day', 'analytics-avg-group-size', 'analytics-return-visitors', 'analytics-popular-purpose'].forEach(id => document.getElementById(id).textContent = '--');
                    updatePagination('analytics');
                    return;
                }
                updateAnalyticsStats(analyticData);
                renderAllAnalyticsCharts(analyticData);
                displayAnalyticsTables(analyticData);
                if (compareFrom1 && compareTo1 && compareFrom2 && compareTo2) {
                    performPeriodComparison(visitors, compareFrom1, compareTo1, compareFrom2, compareTo2);
                } else {
                    document.getElementById('comparative-analysis-content').innerHTML = '<p>موازنہ کا تجزیہ دیکھنے کے لیے دو مدتیں منتخب کریں۔</p>';
                }
                performIndividualGroupAnalysis(visitors);
                if (selectedGroupTags.length >= 2) {
                    performGroupTagComparison(visitors, selectedGroupTags);
                } else {
                    document.getElementById('comparative-analysis-content').innerHTML += '<p>گروپ ٹیگ کا موازنہ کرنے کے لیے کم از کم دو گروپ ٹیگز منتخب کریں۔</p>';
                }
            };
            request.onerror = function (event) {
                console.error('Error loading analytics data:', event.target.error);
            };
        }
        function updateAnalyticsStats(visitors) {
            const totalAttendees = visitors.reduce((sum, v) => sum + (v.groupCount || 1), 0);
            const dayCount = {};
            const purposeCount = {};
            const phoneArrivals = {};
            visitors.forEach(v => {
                const day = new Date(v.arrivalDate).toLocaleDateString('ur-PK', { weekday: 'long' });
                dayCount[day] = (dayCount[day] || 0) + 1;
                if (v.purpose) purposeCount[v.purpose] = (purposeCount[v.purpose] || 0) + 1;
                if (v.phone) {
                    if (!phoneArrivals[v.phone]) phoneArrivals[v.phone] = [];
                    phoneArrivals[v.phone].push(v.arrivalDate);
                }
            });
            let returnVisitorsCount = 0;
            for (const phone in phoneArrivals) {
                if (phoneArrivals[phone].length > 1) {
                    const uniqueArrivalDates = new Set(phoneArrivals[phone]);
                    if (uniqueArrivalDates.size > 1) {
                        returnVisitorsCount++;
                    }
                }
            }
            const peakDay = Object.keys(dayCount).length ? Object.entries(dayCount).reduce((a, b) => a[1] > b[1] ? a : b)[0] : '--';
            const popularPurpose = Object.keys(purposeCount).length ? Object.entries(purposeCount).reduce((a, b) => a[1] > b[1] ? a : b)[0] : '--';
            const groupVisitors = visitors.filter(v => v.type === 'گروپ');
            const totalGroupSize = groupVisitors.reduce((sum, v) => sum + (v.groupCount || 1), 0);
            const avgGroupSize = groupVisitors.length > 0 ? Math.round(totalGroupSize / groupVisitors.length) : 0;
            document.getElementById('analytics-peak-day').textContent = peakDay;
            document.getElementById('analytics-popular-purpose').textContent = popularPurpose;
            document.getElementById('analytics-avg-group-size').textContent = avgGroupSize;
            document.getElementById('analytics-return-visitors').textContent = returnVisitorsCount;
        }
        function displayAnalyticsTables(visitors) {
            const chartsContainer = document.getElementById('analytics-tables');
            let analyticsHtml = '';
            const totalAttendees = visitors.reduce((sum, v) => sum + (v.groupCount || 1), 0);
            const cityCount = {}, purposeCount = {}, provinceCount = {}, dayCount = {};
            visitors.forEach(v => {
                const members = v.groupCount || 1;
                const city = v.address?.split('،')[0]?.trim() || 'نامعلوم';
                const province = getProvince(v.address?.split('،').pop()?.trim());
                cityCount[city] = (cityCount[city] || 0) + members;
                provinceCount[province] = (provinceCount[province] || 0) + members;
                if (v.purpose) purposeCount[v.purpose] = (purposeCount[v.purpose] || 0) + 1;
                const day = new Date(v.arrivalDate).toLocaleDateString('ur-PK', { weekday: 'long' });
                dayCount[day] = (dayCount[day] || 0) + 1;
            });
            const createTable = (title, data, total, col1, col2, col3, sorted = true, limit = null) => {
                let html = `<div class="reports-section"><h3>${title}</h3><table class="data-table"><thead><tr><th>${col1}</th><th>${col2}</th><th>${col3}</th></tr></thead><tbody>`;
                let sortedData = Object.entries(data);
                if (sorted) sortedData.sort((a, b) => b[1] - a[1]);
                if (limit) sortedData = sortedData.slice(0, limit);
                sortedData.forEach(([key, value]) => {
                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                    html += `<tr><td>${key}</td><td>${value}</td><td>${percentage}</td></tr>`;
                });
                html += `</tbody></table></div>`;
                return html;
            };
            analyticsHtml += createTable('صوبے کے لحاظ سے حاضری', provinceCount, totalAttendees, 'صوبہ', 'کل افراد', 'حصہ');
            analyticsHtml += createTable('شہر کے لحاظ سے حاضری (ٹاپ 10)', cityCount, totalAttendees, 'شہر', 'کل افراد', 'حصہ', true, 10);
            analyticsHtml += createTable('مقصد کے لحاظ سے آمد', purposeCount, visitors.length, 'مقصد', 'آمد کی تعداد', 'حصہ');
            analyticsHtml += createTable('دن کے لحاظ سے آمد', dayCount, visitors.length, 'دن', 'آمد کی تعداد', 'حصہ');
            chartsContainer.innerHTML = analyticsHtml;
            updatePagination('analytics');
        }
        function populateGroupTagCompareSelect() {
            const select = document.getElementById('group-tag-compare');
            select.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'منتخب کریں...';
            select.appendChild(defaultOption);
            const transaction = db.transaction(['visitors'], 'readonly');
            const objectStore = transaction.objectStore('visitors');
            const request = objectStore.index('groupTag').getAllKeys();
            request.onsuccess = function () {
                const groupTags = new Set(request.result.filter(tag => typeof tag === 'string' && tag.trim() !== ''));
                Array.from(groupTags).sort().forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag;
                    option.textContent = tag;
                    select.appendChild(option);
                });
            };
        }
        function getPeriodMetrics(visitors, fromDate, toDate) {
            const periodVisitors = visitors.filter(v => {
                const arrival = new Date(v.arrivalDate);
                return arrival >= new Date(fromDate) && arrival <= new Date(toDate);
            });
            const totalVisitors = periodVisitors.length;
            const totalAttendees = periodVisitors.reduce((sum, v) => sum + (v.groupCount || 1), 0);
            const totalGroups = periodVisitors.filter(v => v.type === 'گروپ').length;
            const stayDurations = periodVisitors
                .filter(v => v.departureDate && v.arrivalDate)
                .map(v => {
                    const arrival = new Date(v.arrivalDate);
                    const departure = new Date(v.departureDate);
                    const diffTime = Math.abs(departure.getTime() - arrival.getTime());
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                })
                .filter(duration => !isNaN(duration) && duration > 0);
            const averageStay = stayDurations.length > 0 ?
                (stayDurations.reduce((a, b) => a + b, 0) / stayDurations.length).toFixed(1) : '0';
            const purposeCount = {};
            periodVisitors.forEach(v => {
                const purpose = v.purpose || 'نامعلوم';
                purposeCount[purpose] = (purposeCount[purpose] || 0) + 1;
            });
            const topPurpose = Object.keys(purposeCount).length ? Object.entries(purposeCount).sort((a, b) => b[1] - a[1])[0][0] : 'نامعلوم';
            const cityCount = {};
            periodVisitors.forEach(v => {
                const city = v.address?.split('،')[0]?.trim() || 'نامعلوم';
                cityCount[city] = (cityCount[city] || 0) + (v.groupCount || 1);
            });
            const topCity = Object.keys(cityCount).length ? Object.entries(cityCount).sort((a, b) => b[1] - a[1])[0][0] : 'نامعلوم';
            return {
                totalVisitors,
                totalAttendees,
                totalGroups,
                averageStay,
                topPurpose,
                topCity
            };
        }
        function performPeriodComparison(visitors, from1, to1, from2, to2) {
            const metrics1 = getPeriodMetrics(visitors, from1, to1);
            const metrics2 = getPeriodMetrics(visitors, from2, to2);
            let html = `
                <div class="reports-section">
                    <h3>مدت کا موازنہ: ${formatDate(from1)} تا ${formatDate(to1)} بمقابلہ ${formatDate(from2)} تا ${formatDate(to2)}</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>اشاریہ</th>
                                <th>پہلی مدت</th>
                                <th>دوسری مدت</th>
                                <th>تبدیلی</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>کل زائرین</td>
                                <td>${metrics1.totalVisitors}</td>
                                <td>${metrics2.totalVisitors}</td>
                                <td>${metrics2.totalVisitors - metrics1.totalVisitors}</td>
                            </tr>
                            <tr>
                                <td>کل حاضری (افراد)</td>
                                <td>${metrics1.totalAttendees}</td>
                                <td>${metrics2.totalAttendees}</td>
                                <td>${metrics2.totalAttendees - metrics1.totalAttendees}</td>
                            </tr>
                            <tr>
                                <td>کل گروپس</td>
                                <td>${metrics1.totalGroups}</td>
                                <td>${metrics2.totalGroups}</td>
                                <td>${metrics2.totalGroups - metrics1.totalGroups}</td>
                            </tr>
                            <tr>
                                <td>اوسط قیام (دن)</td>
                                <td>${metrics1.averageStay}</td>
                                <td>${metrics2.averageStay}</td>
                                <td>${(parseFloat(metrics2.averageStay) - parseFloat(metrics1.averageStay)).toFixed(1)}</td>
                            </tr>
                            <tr>
                                <td>مشہور ترین مقصد</td>
                                <td>${metrics1.topPurpose}</td>
                                <td>${metrics2.topPurpose}</td>
                                <td>--</td>
                            </tr>
                            <tr>
                                <td>مشہور ترین شہر</td>
                                <td>${metrics1.topCity}</td>
                                <td>${metrics2.topCity}</td>
                                <td>--</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('comparative-analysis-content').innerHTML += html;
        }
        function performIndividualGroupAnalysis(visitors) {
            const individuals = visitors.filter(v => v.type === 'فرد');
            const groups = visitors.filter(v => v.type === 'گروپ');
            const getAnalysisData = (data) => {
                const totalVisitors = data.length;
                const totalAttendees = data.reduce((sum, v) => sum + (v.groupCount || 1), 0);
                const stayDurations = data
                    .filter(v => v.departureDate && v.arrivalDate)
                    .map(v => {
                        const arrival = new Date(v.arrivalDate);
                        const departure = new Date(v.departureDate);
                        const diffTime = Math.abs(departure.getTime() - arrival.getTime());
                        return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    })
                    .filter(duration => !isNaN(duration) && duration > 0);
                const averageStay = stayDurations.length > 0 ? (stayDurations.reduce((a, b) => a + b, 0) / stayDurations.length).toFixed(1) : '0';
                const purposeCount = {};
                data.forEach(v => {
                    const purpose = v.purpose || 'نامعلوم';
                    purposeCount[purpose] = (purposeCount[purpose] || 0) + 1;
                });
                const topPurpose = Object.keys(purposeCount).length ? Object.entries(purposeCount).sort((a, b) => b[1] - a[1])[0][0] : 'نامعلوم';
                const cityCount = {};
                data.forEach(v => {
                    const city = v.address?.split('،')[0]?.trim() || 'نامعلوم';
                    cityCount[city] = (cityCount[city] || 0) + (v.groupCount || 1);
                });
                const topCity = Object.keys(cityCount).length ? Object.entries(cityCount).sort((a, b) => b[1] - a[1])[0][0] : 'نامعلوم';
                return { totalVisitors, totalAttendees, averageStay, topPurpose, topCity };
            };
            const individualData = getAnalysisData(individuals);
            const groupData = getAnalysisData(groups);
            let html = `
                <div class="reports-section">
                    <h3>انفرادی بمقابلہ گروپ تجزیہ</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>اشاریہ</th>
                                <th>انفرادی زائرین</th>
                                <th>گروپ زائرین</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>کل زائرین کی آمد</td><td>${individualData.totalVisitors}</td><td>${groupData.totalVisitors}</td></tr>
                            <tr><td>کل افراد کی حاضری</td><td>${individualData.totalAttendees}</td><td>${groupData.totalAttendees}</td></tr>
                            <tr><td>اوسط قیام (دن)</td><td>${individualData.averageStay}</td><td>${groupData.averageStay}</td></tr>
                            <tr><td>مشہور ترین مقصد</td><td>${individualData.topPurpose}</td><td>${groupData.topPurpose}</td></tr>
                            <tr><td>مشہور ترین شہر</td><td>${individualData.topCity}</td><td>${groupData.topCity}</td></tr>
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('comparative-analysis-content').innerHTML += html;
        }
        function performGroupTagComparison(visitors, selectedGroupTags) {
            if (selectedGroupTags.length < 2) return;
            let html = `
                <div class="reports-section">
                    <h3>گروپ ٹیگ کا موازنہ</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>اشاریہ</th>
            `;
            selectedGroupTags.forEach(tag => {
                html += `<th>${tag}</th>`;
            });
            html += `
                            </tr>
                        </thead>
                        <tbody>
            `;
            const metrics = {
                'کل زائرین': {},
                'کل افراد': {},
                'اوسط قیام (دن)': {},
                'مشہور ترین مقصد': {},
                'مشہور ترین شہر': {}
            };
            selectedGroupTags.forEach(tag => {
                const groupVisitors = visitors.filter(v => v.groupTag === tag);
                const data = getPeriodMetrics(groupVisitors, '0000-01-01', '9999-12-31');
                metrics['کل زائرین'][tag] = data.totalVisitors;
                metrics['کل افراد'][tag] = data.totalAttendees;
                metrics['اوسط قیام (دن)'][tag] = data.averageStay;
                metrics['مشہور ترین مقصد'][tag] = data.topPurpose;
                metrics['مشہور ترین شہر'][tag] = data.topCity;
            });
            for (const key in metrics) {
                html += `<tr><td>${key}</td>`;
                selectedGroupTags.forEach(tag => {
                    html += `<td>${metrics[key][tag]}</td>`;
                });
                html += `</tr>`;
            }
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('comparative-analysis-content').innerHTML += html;
        }
        function exportToExcel(type) {
            const transaction = db.transaction(['visitors'], 'readonly');
            const objectStore = transaction.objectStore('visitors');
            const request = objectStore.getAll();
            request.onsuccess = function () {
                let visitorsToExport = request.result;
                let dataToExport;
                let filenamePrefix = 'رپورٹ';
                if (type === 'filtered') {
                    visitorsToExport = filteredVisitors;
                    filenamePrefix = 'فلٹرڈ_زائرین';
                } else if (type === 'current_report') {
                    const reportType = document.getElementById('report-type')?.value || 'all';
                    if (reportType === 'period-summary') {
                        dataToExport = getSummaryData(reportedVisitors);
                        filenamePrefix = 'خلاصہ_رپورٹ';
                    } else if (reportType === 'purpose-breakdown') {
                        dataToExport = getPurposeBreakdownData(reportedVisitors);
                        filenamePrefix = 'مقصد_تقسیم_رپورٹ';
                    } else if (reportType === 'geographic-breakdown') {
                        dataToExport = getGeographicBreakdownData(reportedVisitors);
                        filenamePrefix = 'جغرافیائی_تقسیم_رپورٹ';
                    } else {
                        dataToExport = prepareDetailedVisitorData(reportedVisitors);
                        filenamePrefix = 'تفصیلی_رپورٹ';
                    }
                } else if (type === 'summary') {
                    dataToExport = getSummaryData(visitorsToExport);
                    filenamePrefix = 'خلاصہ_رپورٹ';
                } else if (type === 'detailed') {
                    dataToExport = prepareDetailedVisitorData(visitorsToExport);
                    filenamePrefix = 'تفصیلی_رپورٹ';
                }
                if (!dataToExport) {
                    dataToExport = prepareDetailedVisitorData(visitorsToExport);
                }
                if (dataToExport.length === 0) {
                    alert('ایکسپورٹ کے لیے کوئی ڈیٹا نہیں ہے۔');
                    return;
                }
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const address = XLSX.utils.encode_col(C) + "1";
                    if (!ws[address]) continue;
                    ws[address].s = {
                        font: { bold: true },
                        fill: { bgColor: { indexed: 64 }, fgColor: { rgb: "FFFFFF" } }
                    };
                }
                XLSX.utils.book_append_sheet(wb, ws, 'زائرین کی فہرست');
                const filename = `${filenamePrefix}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);
            };
            request.onerror = function (event) {
                console.error('Error fetching data for Excel export:', event.target.error);
                alert('ڈیٹا ایکسپورٹ کرنے میں خرابی پیش آئی۔');
            };
        }
        function prepareDetailedVisitorData(visitors) {
            return visitors.map(v => ({
                'شناختی نمبر': v.id,
                'نام': v.name,
                'فون نمبر': v.phone || '',
                'پتہ': v.address || '',
                'تاریخ آمد': formatDate(v.arrivalDate),
                'آمد کا وقت': v.arrivalTime || '',
                'تاریخ روانگی': v.departureDate ? formatDate(v.departureDate) : '',
                'قیام کے دن': v.departureDate && v.arrivalDate ? (Math.ceil(Math.abs(new Date(v.departureDate).getTime() - new Date(v.arrivalDate).getTime()) / (1000 * 60 * 60 * 24)) + 1) : '',
                'قسم': v.type,
                'افراد کی تعداد': v.groupCount || 1,
                'مقصد': v.purpose || '',
                'گروپ ٹیگ': v.groupTag || '',
                'ذمہ دار شخص': v.responsiblePerson || '',
                'خصوصی نوٹس': v.specialNotes || '',
                'موجودگی': isVisitorPresent(v) ? 'موجود' : (isVisitorOverstay(v) ? 'حد سے زیادہ قیام' : 'غیر موجود'),
                'شامل ہونے کی تاریخ': formatDate(v.addedDate)
            }));
        }
        function getSummaryData(visitors) {
            const totalVisitors = visitors.length;
            const totalAttendees = visitors.reduce((sum, v) => sum + (v.groupCount || 1), 0);
            const presentVisitors = visitors.filter(v => isVisitorPresent(v)).length;
            const presentAttendees = visitors.filter(v => isVisitorPresent(v)).reduce((sum, v) => sum + (v.groupCount || 1), 0);
            const totalGroups = visitors.filter(v => v.type === 'گروپ').length;
            const cityCount = {}, purposeCount = {}, provinceCount = {};
            visitors.forEach(v => {
                const members = v.groupCount || 1;
                const city = v.address?.split('،')[0]?.trim() || 'نامعلوم';
                const province = getProvince(v.address?.split('،').pop()?.trim());
                cityCount[city] = (cityCount[city] || 0) + members;
                provinceCount[province] = (provinceCount[province] || 0) + members;
                if (v.purpose) purposeCount[v.purpose] = (purposeCount[v.purpose] || 0) + 1;
            });
            const summary = [
                { 'اشاریہ': 'کل زائرین', 'تعداد': totalVisitors },
                { 'اشاریہ': 'کل حاضری (افراد)', 'تعداد': totalAttendees },
                { 'اشاریہ': 'موجودہ زائرین', 'تعداد': presentVisitors },
                { 'اشاریہ': 'موجودہ حاضری (افراد)', 'تعداد': presentAttendees },
                { 'اشاریہ': 'کل گروپس', 'تعداد': totalGroups },
                { 'اشاریہ': '', 'تعداد': '' },
                { 'اشاریہ': 'مقصد کے لحاظ سے (زائرین کی تعداد)', 'تعداد': '' },
            ];
            Object.entries(purposeCount).sort((a, b) => b[1] - a[1]).forEach(([purpose, count]) => {
                summary.push({ 'اشاریہ': purpose, 'تعداد': count });
            });
            summary.push({ 'اشاریہ': '', 'تعداد': '' });
            summary.push({ 'اشاریہ': 'صوبے کے لحاظ سے (کل افراد)', 'تعداد': '' });
            Object.entries(provinceCount).sort((a, b) => b[1] - a[1]).forEach(([province, count]) => {
                summary.push({ 'اشاریہ': province, 'تعداد': count });
            });
            summary.push({ 'اشاریہ': '', 'تعداد': '' });
            summary.push({ 'اشاریہ': 'شہر کے لحاظ سے (کل افراد - ٹاپ 10)', 'تعداد': '' });
            Object.entries(cityCount).sort((a, b) => b[1] - a[1]).slice(0, 10).forEach(([city, count]) => {
                summary.push({ 'اشاریہ': city, 'تعداد': count });
            });
            return summary;
        }
        function getPurposeBreakdownData(visitors) {
            const purposeCount = {};
            visitors.forEach(v => {
                const purpose = v.purpose || 'نامعلوم';
                purposeCount[purpose] = (purposeCount[purpose] || 0) + (v.groupCount || 1);
            });
            const totalAttendees = visitors.reduce((sum, v) => sum + (v.groupCount || 1), 0);
            return Object.entries(purposeCount)
                .sort((a, b) => b[1] - a[1])
                .map(([purpose, count]) => ({
                    'مقصد': purpose,
                    'کل افراد': count,
                    'فیصد': totalAttendees > 0 ? ((count / totalAttendees) * 100).toFixed(1) + '%' : '0%'
                }));
        }
        function getGeographicBreakdownData(visitors) {
            const cityCount = {};
            const provinceCount = {};
            visitors.forEach(v => {
                const members = v.groupCount || 1;
                const city = v.address?.split('،')[0]?.trim() || 'نامعلوم';
                const province = getProvince(v.address?.split('،').pop()?.trim());
                cityCount[city] = (cityCount[city] || 0) + members;
                provinceCount[province] = (provinceCount[province] || 0) + members;
            });
            const totalAttendees = visitors.reduce((sum, v) => sum + (v.groupCount || 1), 0);
            const provinceData = Object.entries(provinceCount)
                .sort((a, b) => b[1] - a[1])
                .map(([province, count]) => ({
                    'صوبہ': province,
                    'کل افراد': count,
                    'فیصد': totalAttendees > 0 ? ((count / totalAttendees) * 100).toFixed(1) + '%' : '0%'
                }));
            const cityData = Object.entries(cityCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([city, count]) => ({
                    'شہر': city,
                    'کل افراد': count,
                    'فیصد': totalAttendees > 0 ? ((count / totalAttendees) * 100).toFixed(1) + '%' : '0%'
                }));
            return [...provinceData, { 'صوبہ': '', 'کل افراد': '', 'فیصد': '' }, ...cityData];
        }
        function exportFiltered() {
            exportToExcel('filtered');
        }
        function generatePDFReport() {
            const printWindow = window.open('', '_blank');
            const content = document.getElementById('reports-container').innerHTML;
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>زائرین کی رپورٹ</title>
                    <style>
                        body { font-family: 'Calibri', 'Noto Sans Arabic', Arial, sans-serif; direction: rtl; margin: 20px; }
                        h1, h3, h4 { text-align: center; margin-bottom: 15px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px;}
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: right; font-size: 0.9em; }
                        th { background-color: #f2f2f2; }
                        .reports-section { margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px; }
                        .reports-section h4 { text-align: right; margin-bottom: 10px; font-size: 1.1em;}
                        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;}
                        .stat-card { background: #f0f0f0; padding: 10px; border-radius: 5px; text-align: center; }
                        .stat-card h3 { font-size: 1.5rem; margin-bottom: 5px; }
                        .stat-card p { font-size: 0.9rem; }
                        @media print { body { -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <h1>دارالایمان کربوغہ شریف - زائرین کی رپورٹ</h1>
                    ${content}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        function printReport() {
            generatePDFReport();
        }
        function backupData() {
            const transaction = db.transaction(['visitors', 'addresses', 'purposes'], 'readonly');
            const promises = [];
            promises.push(new Promise((resolve, reject) => {
                const visitorsStore = transaction.objectStore('visitors');
                const visitorsRequest = visitorsStore.getAll();
                visitorsRequest.onsuccess = () => resolve({ visitors: visitorsRequest.result });
                visitorsRequest.onerror = (event) => reject(event.target.error);
            }));
            promises.push(new Promise((resolve, reject) => {
                const addressesStore = transaction.objectStore('addresses');
                const addressesRequest = addressesStore.getAll();
                addressesRequest.onsuccess = () => resolve({ addresses: addressesRequest.result });
                addressesRequest.onerror = (event) => reject(event.target.error);
            }));
            promises.push(new Promise((resolve, reject) => {
                const purposesStore = transaction.objectStore('purposes');
                const purposesRequest = purposesStore.getAll();
                purposesRequest.onsuccess = () => resolve({ purposes: purposesRequest.result });
                purposesRequest.onerror = (event) => reject(event.target.error);
            }));
            Promise.all(promises).then(results => {
                const data = {
                    visitors: results[0].visitors,
                    addresses: results[1].addresses,
                    purposes: results[2].purposes,
                    exportDate: new Date().toISOString(),
                    version: '3.0'
                };
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `visitors_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert('بیک اپ کامیابی سے محفوظ ہو گیا!');
            }).catch(error => {
                console.error('Backup failed:', error);
                alert('بیک اپ بنانے میں خرابی!');
            });
        }
        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.visitors || !Array.isArray(data.visitors)) {
                        alert('غلط فائل فارمیٹ! یہ زائرین کا بیک اپ نہیں ہے۔');
                        return;
                    }
                    if (confirm('کیا آپ واقعی ڈیٹا بحال کرنا چاہتے ہیں؟ موجودہ ڈیٹا مٹ جائے گا اور نئے ڈیٹا سے بدل جائے گا۔')) {
                        const transaction = db.transaction(['visitors', 'addresses', 'purposes'], 'readwrite');
                        const visitorsStore = transaction.objectStore('visitors');
                        const addressesStore = transaction.objectStore('addresses');
                        const purposesStore = transaction.objectStore('purposes');
                        const visitorClearRequest = visitorsStore.clear();
                        visitorClearRequest.onsuccess = function () {
                            data.visitors.forEach(visitor => {
                                visitorsStore.add(visitor);
                            });
                        };
                        visitorClearRequest.onerror = function (event) {
                            console.error('Error clearing visitors store:', event.target.error);
                        };
                        const addressClearRequest = addressesStore.clear();
                        addressClearRequest.onsuccess = function () {
                            if (data.addresses) {
                                data.addresses.forEach(address => {
                                    addressesStore.add(address);
                                });
                            }
                        };
                        addressClearRequest.onerror = function (event) {
                            console.error('Error clearing addresses store:', event.target.error);
                        };
                        const purposesClearRequest = purposesStore.clear();
                        purposesClearRequest.onsuccess = function () {
                            if (data.purposes) {
                                data.purposes.forEach(purpose => {
                                    purposesStore.add(purpose);
                                });
                            }
                        };
                        purposesClearRequest.onerror = function (event) {
                            console.error('Error clearing purposes store:', event.target.error);
                        };
                        transaction.oncomplete = function () {
                            loadDashboard();
                            loadVisitorsList();
                            populateFilterOptions();
                            populatePurposeSelects();
                            populateGroupTagCompareSelect();
                            alert('ڈیٹا کامیابی سے بحال ہو گیا!');
                        };
                        transaction.onerror = function (event) {
                            console.error('Restore transaction failed:', event.target.error);
                            alert('ڈیٹا بحال کرنے میں خرابی پیش آئی: ' + event.target.error.message);
                        };
                    }
                } catch (error) {
                    console.error('File parsing error:', error);
                    alert('فائل پڑھنے میں خرابی! ممکن ہے یہ ایک درست JSON فائل نہ ہو۔');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        function cleanOldData() {
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            sixMonthsAgo.setHours(0, 0, 0, 0);
            if (confirm('کیا آپ واقعی 6 ماہ سے پرانے زائرین کا ڈیٹا صاف کرنا چاہتے ہیں؟ (آمد کی تاریخ کے مطابق)')) {
                const transaction = db.transaction(['visitors'], 'readwrite');
                const objectStore = transaction.objectStore('visitors');
                const request = objectStore.getAll();
                request.onsuccess = function () {
                    const visitors = request.result;
                    let deletedCount = 0;
                    const deletePromises = visitors.map(visitor => {
                        return new Promise((resolve, reject) => {
                            const arrivalDate = new Date(visitor.arrivalDate);
                            arrivalDate.setHours(0, 0, 0, 0);
                            if (arrivalDate < sixMonthsAgo) {
                                const deleteReq = objectStore.delete(visitor.id);
                                deleteReq.onsuccess = () => { deletedCount++; resolve(); };
                                deleteReq.onerror = (event) => reject(event.target.error);
                            } else {
                                resolve();
                            }
                        });
                    });
                    Promise.all(deletePromises)
                        .then(() => {
                            transaction.oncomplete = function () {
                                loadDashboard();
                                loadVisitorsList();
                                alert(`${deletedCount} پرانے ریکارڈز صاف کر دیے گئے!`);
                            };
                            transaction.onerror = function (event) {
                                console.error('Clean old data transaction failed:', event.target.error);
                                alert('پرانا ڈیٹا صاف کرنے میں خرابی پیش آئی: ' + event.target.error.message);
                            };
                        })
                        .catch(error => {
                            console.error('Error in delete promises:', error);
                            alert('پرانا ڈیٹا صاف کرنے کے دوران ایک غیر متوقع خرابی پیش آئی۔');
                        });
                };
                request.onerror = function (event) {
                    console.error('Error getting visitors for clean old data:', event.target.error);
                };
            }
        }
        function clearAllData() {
            if (confirm('کیا آپ واقعی تمام ڈیٹا صاف کرنا چاہتے ہیں؟ یہ عمل واپس نہیں ہو سکتا۔')) {
                const transaction = db.transaction(['visitors', 'addresses', 'purposes'], 'readwrite');
                const visitorsClearReq = transaction.objectStore('visitors').clear();
                visitorsClearReq.onerror = function (event) {
                    console.error('Error clearing visitors store:', event.target.error);
                };
                const addressesClearReq = transaction.objectStore('addresses').clear();
                addressesClearReq.onerror = function (event) {
                    console.error('Error clearing addresses store:', event.target.error);
                };
                const purposesClearReq = transaction.objectStore('purposes').clear();
                purposesClearReq.onerror = function (event) {
                    console.error('Error clearing purposes store:', event.target.error);
                };
                transaction.oncomplete = function () {
                    loadDashboard();
                    loadVisitorsList();
                    populateFilterOptions();
                    populatePurposeSelects();
                    populateGroupTagCompareSelect();
                    alert('تمام ڈیٹا صاف کر دیا گیا!');
                };
                transaction.onerror = function (event) {
                    console.error('Clear all data transaction failed:', event.target.error);
                    alert('تمام ڈیٹا صاف کرنے میں خرابی پیش آئی: ' + event.target.error.message);
                };
            }
        }
        function showIncompleteRecords() {
            const transaction = db.transaction(['visitors'], 'readonly');
            const objectStore = transaction.objectStore('visitors');
            const request = objectStore.getAll();
            request.onsuccess = function () {
                const allRecords = request.result;
                const incomplete = allRecords.filter(v =>
                    !v.phone || v.phone.trim() === '' ||
                    !v.address || v.address.trim() === '' ||
                    !v.departureDate || v.departureDate.trim() === ''
                );
                let html = `
                    <h3>نامکمل ریکارڈز</h3>
                    <p>${incomplete.length} نامکمل ریکارڈز ملے ہیں۔</p>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>نام</th>
                                <th>فون</th>
                                <th>پتہ</th>
                                <th>تاریخ آمد</th>
                                <th>تاریخ روانگی</th>
                                <th>گمشدہ فیلڈز</th>
                                <th>کارروائی</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                if (incomplete.length === 0) {
                    html += `<tr><td colspan="7" style="text-align: center;">کوئی نامکمل ریکارڈز نہیں ہیں۔</td></tr>`;
                } else {
                    incomplete.forEach(v => {
                        const missing = [];
                        if (!v.phone || v.phone.trim() === '') missing.push('فون');
                        if (!v.address || v.address.trim() === '') missing.push('پتہ');
                        if (!v.departureDate || v.departureDate.trim() === '') missing.push('تاریخ روانگی');
                        html += `
                            <tr>
                                <td>${v.name}</td>
                                <td>${v.phone || '--'}</td>
                                <td>${v.address || '--'}</td>
                                <td>${formatDate(v.arrivalDate)}</td>
                                <td>${v.departureDate ? formatDate(v.departureDate) : '--'}</td>
                                <td>${missing.join(', ')}</td>
                                <td><button class="btn btn-sm btn-warning" onclick="editVisitor(${v.id})">تبدیل کریں</button></td>
                            </tr>
                        `;
                    });
                }
                html += `</tbody></table>`;
                document.getElementById('data-quality-results').innerHTML = html;
            };
        }
        function showPotentialDuplicates() {
            const transaction = db.transaction(['visitors'], 'readonly');
            const objectStore = transaction.objectStore('visitors');
            const request = objectStore.getAll();
            request.onsuccess = function () {
                const allRecords = request.result;
                const duplicates = [];
                const processed = new Set();
                for (let i = 0; i < allRecords.length; i++) {
                    if (processed.has(allRecords[i].id)) continue;
                    const current = allRecords[i];
                    const possibleDuplicates = allRecords.filter((other, idx) => {
                        if (current.id === other.id || processed.has(other.id)) return false;
                        const nameMatch = current.name === other.name;
                        const phoneMatch = current.phone && other.phone && current.phone === other.phone;
                        return nameMatch || (phoneMatch && (current.name.includes(other.name) || other.name.includes(current.name)));
                    });
                    if (possibleDuplicates.length > 0) {
                        duplicates.push([current, ...possibleDuplicates]);
                        processed.add(current.id);
                        possibleDuplicates.forEach(d => processed.add(d.id));
                    }
                }
                let html = `
                    <h3>ممکنہ نقلیں</h3>
                    <p>${duplicates.length} ممکنہ نقلوں کے گروپس ملے ہیں۔</p>
                `;
                if (duplicates.length === 0) {
                    html += `<p style="text-align: center;">کوئی ممکنہ نقلیں نہیں ہیں۔</p>`;
                } else {
                    duplicates.forEach((group, index) => {
                        html += `
                            <div class="reports-section" style="border: 1px solid var(--accent-color); margin-bottom: 20px;">
                                <h4>نقلوں کا گروپ ${index + 1}</h4>
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>شناختی نمبر</th>
                                            <th>نام</th>
                                            <th>فون</th>
                                            <th>پتہ</th>
                                            <th>تاریخ آمد</th>
                                            <th>مقصد</th>
                                            <th>کارروائی</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        group.forEach(v => {
                            html += `
                                <tr>
                                    <td>${v.id}</td>
                                    <td>${v.name}</td>
                                    <td>${v.phone || '--'}</td>
                                    <td>${v.address || '--'}</td>
                                    <td>${formatDate(v.arrivalDate)}</td>
                                    <td>${v.purpose || '--'}</td>
                                    <td><button class="btn btn-sm btn-warning" onclick="editVisitor(${v.id})">تبدیل کریں</button> <button class="btn btn-sm btn-danger" onclick="deleteVisitor(${v.id})">حذف کریں</button></td>
                                </tr>
                            `;
                        });
                        html += `</tbody></table></div>`;
                    });
                }
                document.getElementById('data-quality-results').innerHTML = html;
            };
        }
        function updateRecordsPerPage() {
            recordsPerPageVisitors = parseInt(document.getElementById('records-per-page').value);
            visitorsCurrentPage = 1;
            displayVisitors();
            localStorage.setItem('recordsPerPageVisitors', recordsPerPageVisitors);
        }
        function updateReportsRecordsPerPage() {
            recordsPerPageReports = parseInt(document.getElementById('reports-records-per-page').value);
            reportsCurrentPage = 1;
            generateReports();
            localStorage.setItem('recordsPerPageReports', recordsPerPageReports);
        }
        function updateAnalyticsRecordsPerPage() {
            recordsPerPageAnalytics = parseInt(document.getElementById('analytics-records-per-page').value);
            analyticsCurrentPage = 1;
            loadAnalytics();
            localStorage.setItem('recordsPerPageAnalytics', recordsPerPageAnalytics);
        }
        function setInitialRecordsPerPage() {
            const storedPerPageVisitors = localStorage.getItem('recordsPerPageVisitors');
            if (storedPerPageVisitors) {
                recordsPerPageVisitors = parseInt(storedPerPageVisitors);
                document.getElementById('records-per-page').value = storedPerPageVisitors;
            }
            const storedPerPageReports = localStorage.getItem('recordsPerPageReports');
            if (storedPerPageReports) {
                recordsPerPageReports = parseInt(storedPerPageReports);
                document.getElementById('reports-records-per-page').value = storedPerPageReports;
            }
            const storedPerPageAnalytics = localStorage.getItem('recordsPerPageAnalytics');
            if (storedPerPageAnalytics) {
                recordsPerPageAnalytics = parseInt(storedPerPageAnalytics);
                document.getElementById('analytics-records-per-page').value = storedPerPageAnalytics;
            }
        }
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            const btn = document.querySelector('.dark-toggle');
            btn.textContent = document.body.classList.contains('dark') ? '☀️ لائٹ موڈ' : '🌙 ڈارک موڈ';
            localStorage.setItem('darkMode', document.body.classList.contains('dark'));
        }
        document.getElementById('arrival-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('arrival-time').value = new Date().toTimeString().split(' ')[0].substring(0, 5);
        if (localStorage.getItem('darkMode') === 'true') {
            toggleDarkMode();
        }
        document.querySelectorAll('.nav-tab').forEach(button => {
            button.addEventListener('click', (event) => {
                showTab(event.target.dataset.tab);
            });
        });
        setInitialRecordsPerPage();
        window.onclick = function (event) {
            const modal = document.getElementById('edit-modal');
            if (event.target === modal) {
                closeEditModal();
            }
            const suggestions = document.querySelectorAll('.autocomplete-suggestions');
            suggestions.forEach(s => {
                const parentContainer = s.parentElement;
                if (!parentContainer.contains(event.target) && event.target !== s && !s.contains(event.target)) {
                    s.style.display = 'none';
                }
            });
        };
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeEditModal();
                document.querySelectorAll('.autocomplete-suggestions').forEach(s => s.style.display = 'none');
            }
        });
        function scheduleAutoBackup() {
            const autoBackupSetting = document.getElementById('auto-backup').value;
            localStorage.setItem('autoBackupSetting', autoBackupSetting);
            if (window.autoBackupIntervalId) {
                clearInterval(window.autoBackupIntervalId);
            }
            let intervalMs;
            switch (autoBackupSetting) {
                case 'daily':
                    intervalMs = 24 * 60 * 60 * 1000;
                    break;
                case 'weekly':
                    intervalMs = 7 * 24 * 60 * 60 * 1000;
                    break;
                case 'monthly':
                    intervalMs = 30 * 24 * 60 * 60 * 1000;
                    break;
                case 'never':
                    return;
                default:
                    return;
            }
            const lastBackupTime = parseInt(localStorage.getItem('lastBackupTime') || '0', 10);
            const now = Date.now();
            if (now - lastBackupTime >= intervalMs) {
                console.log('Performing immediate auto backup due to elapsed time...');
                backupData();
                localStorage.setItem('lastBackupTime', now);
            }
            window.autoBackupIntervalId = setInterval(() => {
                console.log('Performing scheduled auto backup...');
                backupData();
                localStorage.setItem('lastBackupTime', Date.now());
            }, intervalMs);
        }
        document.getElementById('auto-backup').value = localStorage.getItem('autoBackupSetting') || 'never';
        document.getElementById('auto-backup').addEventListener('change', scheduleAutoBackup);
        initDB();
    </script>
    <script type="module">
        import { Workbox } from 'https://storage.googleapis.com/workbox-cdn/releases/7.0.0/workbox-window.prod.mjs';

        const swUrl = './sw.js';
        const wb = new Workbox(swUrl);

        wb.addEventListener('waiting', () => {
            console.log('A new service worker is waiting to activate.');
            wb.messageSW({ type: 'SKIP_WAITING' });
        });

        wb.addEventListener('controlling', () => {
            console.log('The new service worker is now in control. Reloading page for updates...');
            window.location.reload();
        });

        wb.register();
    </script>
</body>

</html>